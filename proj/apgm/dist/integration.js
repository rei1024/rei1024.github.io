var Xr=Object.defineProperty;var qr=(e,t)=>{for(var r in t)Xr(e,r,{get:t[r],enumerable:!0})};var u={};qr(u,{Parser:()=>g,all:()=>lr,choice:()=>te,default:()=>mr,eof:()=>fr,fail:()=>Kr,lazy:()=>re,location:()=>It,match:()=>Qr,ok:()=>tt,text:()=>Jr});var g=class{constructor(t){this.action=t}parse(t){let r={index:0,line:1,column:1},n=new rt({input:t,location:r}),s=this.skip(fr).action(n);return s.type==="ActionOK"?{type:"ParseOK",value:s.value}:{type:"ParseFail",location:s.furthest,expected:s.expected}}tryParse(t){let r=this.parse(t);if(r.type==="ParseOK")return r.value;let{expected:n,location:s}=r,{line:i,column:a}=s,p=`parse error at line ${i} column ${a}: expected ${n.join(", ")}`;throw new Error(p)}and(t){return new g(r=>{let n=this.action(r);if(n.type==="ActionFail")return n;r=r.moveTo(n.location);let s=r.merge(n,t.action(r));if(s.type==="ActionOK"){let i=[n.value,s.value];return r.merge(s,r.ok(s.location.index,i))}return s})}skip(t){return this.and(t).map(([r])=>r)}next(t){return this.and(t).map(([,r])=>r)}or(t){return new g(r=>{let n=this.action(r);return n.type==="ActionOK"?n:r.merge(n,t.action(r))})}chain(t){return new g(r=>{let n=this.action(r);if(n.type==="ActionFail")return n;let s=t(n.value);return r=r.moveTo(n.location),r.merge(n,s.action(r))})}map(t){return this.chain(r=>tt(t(r)))}thru(t){return t(this)}desc(t){return new g(r=>{let n=this.action(r);return n.type==="ActionOK"?n:{type:"ActionFail",furthest:n.furthest,expected:t}})}wrap(t,r){return t.next(this).skip(r)}trim(t){return this.wrap(t,t)}repeat(t=0,r=1/0){if(!pr(t,r))throw new Error(`repeat: bad range (${t} to ${r})`);return t===0?this.repeat(1,r).or(tt([])):new g(n=>{let s=[],i=this.action(n);if(i.type==="ActionFail")return i;for(;i.type==="ActionOK"&&s.length<r;){if(s.push(i.value),i.location.index===n.location.index)throw new Error("infinite loop detected; don't call .repeat() with parsers that can accept zero characters");n=n.moveTo(i.location),i=n.merge(i,this.action(n))}return i.type==="ActionFail"&&s.length<t?i:n.merge(i,n.ok(n.location.index,s))})}sepBy(t,r=0,n=1/0){if(!pr(r,n))throw new Error(`sepBy: bad range (${r} to ${n})`);return r===0?this.sepBy(t,1,n).or(tt([])):n===1?this.map(s=>[s]):this.chain(s=>t.next(this).repeat(r-1,n-1).map(i=>[s,...i]))}node(t){return lr(It,this,It).map(([r,n,s])=>({type:"ParseNode",name:t,value:n,start:r,end:s}))}};function pr(e,t){return e<=t&&e>=0&&t>=0&&Number.isInteger(e)&&e!==1/0&&(Number.isInteger(t)||t===1/0)}var It=new g(e=>e.ok(e.location.index,e.location));function tt(e){return new g(t=>t.ok(t.location.index,e))}function Kr(e){return new g(t=>t.fail(t.location.index,e))}var fr=new g(e=>e.location.index<e.input.length?e.fail(e.location.index,["<EOF>"]):e.ok(e.location.index,"<EOF>"));function Jr(e){return new g(t=>{let r=t.location.index,n=r+e.length;return t.input.slice(r,n)===e?t.ok(n,e):t.fail(r,[e])})}function Qr(e){for(let r of e.flags)switch(r){case"i":case"s":case"m":case"u":continue;default:throw new Error("only the regexp flags 'imsu' are supported")}let t=new RegExp(e.source,e.flags+"y");return new g(r=>{let n=r.location.index;t.lastIndex=n;let s=r.input.match(t);if(s){let i=n+s[0].length,a=r.input.slice(n,i);return r.ok(i,a)}return r.fail(n,[String(e)])})}function lr(...e){return e.reduce((t,r)=>t.chain(n=>r.map(s=>[...n,s])),tt([]))}function te(...e){return e.reduce((t,r)=>t.or(r))}function re(e){let t=new g(r=>(t.action=e().action,t.action(r)));return t}function ee(e,t){return[...new Set([...e,...t])]}var rt=class{constructor(t){this.input=t.input,this.location=t.location}moveTo(t){return new rt({input:this.input,location:t})}_internal_move(t){if(t===this.location.index)return this.location;let r=this.location.index,n=t,s=this.input.slice(r,n),{line:i,column:a}=this.location;for(let p of s)p===`
`?(i++,a=1):a++;return{index:t,line:i,column:a}}ok(t,r){return{type:"ActionOK",value:r,location:this._internal_move(t),furthest:{index:-1,line:-1,column:-1},expected:[]}}fail(t,r){return{type:"ActionFail",furthest:this._internal_move(t),expected:r}}merge(t,r){if(r.furthest.index>t.furthest.index)return r;let n=r.furthest.index===t.furthest.index?ee(t.expected,r.expected):t.expected;return r.type==="ActionOK"?{type:"ActionOK",location:r.location,value:r.value,furthest:t.furthest,expected:n}:{type:"ActionFail",furthest:t.furthest,expected:n}}};var mr=null;var l=class{pretty(){return"unimplemented"}extractUnaryRegisterNumbers(){return[]}extractBinaryRegisterNumbers(){return[]}extractLegacyTRegisterNumbers(){return[]}doesReturnValue(){return!1}isSameComponent(t){return!0}};var lt=0,mt=1,dt=2,Dt="A1",_t="B0",Ot="B1",dr="ADD";function ne(e){switch(e){case lt:return Dt;case mt:return _t;case dt:return Ot}}function se(e){switch(e){case Dt:return lt;case _t:return mt;case Ot:return dt}}var D=class extends l{constructor(t){super(),this.op=t}pretty(){return`${dr} ${ne(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===dr&&(s===Dt||s===_t||s===Ot))return new D(se(s))}doesReturnValue(){switch(this.op){case lt:return!1;case mt:return!0;case dt:return!0}}isSameComponent(t){return t instanceof D}};var K=0,J=1,et=2,nt=3,H=4,j=5,st=6,ht="INC",Ct="TDEC",xt="READ",gt="SET",Zt="B2DX",Ut="B2DY",zt="B2D",ie="DEC",hr="SQX",xr="SQY",gr="SQ";function Ar(e){switch(e){case ht:return K;case Ct:return J;case xt:return et;case gt:return nt}}function oe(e){switch(e){case K:return ht;case J:return Ct;case et:return xt;case nt:return gt}}function Er(e){switch(e){case Zt:return H;case Ut:return j;case zt:return st}}function ae(e){switch(e){case H:return Zt;case j:return Ut;case st:return zt}}var A=class extends l{constructor(t,r){super(),this.op=t,this.axis=r}pretty(){return`${oe(this.op)} ${ae(this.axis)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)){if(n===ht||n===Ct){if(s===Zt||s===Ut)return new A(Ar(n),Er(s))}else if((n===xt||n===gt)&&s===zt)return new A(Ar(n),Er(s));switch(n){case ht:switch(s){case hr:return new A(K,H);case xr:return new A(K,j);default:return}case ie:switch(s){case hr:return new A(J,H);case xr:return new A(J,j);default:return}case xt:switch(s){case gr:return new A(et,st);default:return}case gt:switch(s){case gr:return new A(nt,st);default:return}}}}doesReturnValue(){switch(this.op){case K:return!1;case J:return!0;case et:return!0;case nt:return!1}}isSameComponent(t){return t instanceof A?this.axis===H&&t.axis===j?!1:!(this.axis===j&&t.axis===H):!1}};var At=0,Et=1,bt=2,yt=3,kt="INC",Ft="TDEC",Wt="READ",Vt="SET",br="B";function ue(e){switch(e){case At:return kt;case Et:return Ft;case bt:return Wt;case yt:return Vt}}function ce(e){switch(e){case kt:return At;case Ft:return Et;case Wt:return bt;case Vt:return yt}}var T=class extends l{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}extractBinaryRegisterNumbers(){return[this.regNumber]}pretty(){return`${ue(this.op)} ${br}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===kt||n===Ft||n===Wt||n===Vt)&&s.startsWith(br)){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new T(ce(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case At:return!1;case Et:return!0;case bt:return!0;case yt:return!1}}isSameComponent(t){return t instanceof T?this.regNumber===t.regNumber:!1}};var yr="HALT_OUT",E=class extends l{constructor(){super()}pretty(){return yr}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===yr)return new E}doesReturnValue(){return!1}isSameComponent(t){return t instanceof E}};var Yt=0,Ht=1,jt="0",Xt="1",Sr="MUL";function pe(e){switch(e){case jt:return Yt;case Xt:return Ht}}function fe(e){switch(e){case Yt:return jt;case Ht:return Xt}}var U=class extends l{constructor(t){super(),this.op=t}pretty(){return`${Sr} ${fe(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===Sr&&(s===jt||s===Xt))return new U(pe(s))}doesReturnValue(){return!0}isSameComponent(t){return t instanceof U}};var y=class extends l{constructor(){super()}pretty(){return"NOP"}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n==="NOP")return new y}doesReturnValue(){return!0}isSameComponent(t){return t instanceof y}};var wr="OUTPUT",z=class extends l{constructor(t){super(),this.digit=t}pretty(){return`${wr} ${this.digit}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===wr&&s!==void 0)return new z(s)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof z}};var St=0,wt=1,Pt=2,qt="A1",Kt="B0",Jt="B1",Pr="SUB";function le(e){switch(e){case St:return qt;case wt:return Kt;case Pt:return Jt}}function me(e){switch(e){case qt:return St;case Kt:return wt;case Jt:return Pt}}var k=class extends l{constructor(t){super(),this.op=t}pretty(){return`${Pr} ${le(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===Pr&&(s===qt||s===Kt||s===Jt))return new k(me(s))}doesReturnValue(){switch(this.op){case St:return!1;case wt:return!0;case Pt:return!0}}isSameComponent(t){return t instanceof k}};var Gt=0,Nt=1,Qt="INC",tr="TDEC",Gr="U",de="R";function he(e){switch(e){case Gt:return Qt;case Nt:return tr}}function xe(e){switch(e){case Qt:return Gt;case tr:return Nt}}var $=class extends l{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}extractUnaryRegisterNumbers(){return[this.regNumber]}pretty(){return`${he(this.op)} ${Gr}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===Qt||n===tr)&&(s.startsWith(Gr)||s.startsWith(de))){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new $(xe(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case Gt:return!1;case Nt:return!0}}isSameComponent(t){return t instanceof $?this.regNumber===t.regNumber:!1}};var Mt=0,Bt=1,Lt=2,Rt=3,Tt=4,rr="INC",er="DEC",nr="READ",sr="SET",ir="RESET";function ge(e){switch(e){case Mt:return rr;case Bt:return er;case Lt:return nr;case Rt:return sr;case Tt:return ir}}function Ae(e){switch(e){case rr:return Mt;case er:return Bt;case nr:return Lt;case sr:return Rt;case ir:return Tt}}var F=class extends l{constructor(t,r){super(),this.op=t,this.regNumber=r}extractLegacyTRegisterNumbers(){return[this.regNumber]}pretty(){return`${ge(this.op)} T${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===rr||n===er||n===nr||n===sr||n===ir)&&s.startsWith("T")){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new F(Ae(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case Mt:return!0;case Bt:return!0;case Lt:return!0;case Rt:return!1;case Tt:return!1}}isSameComponent(t){return t instanceof F?this.regNumber===t.regNumber:!1}};function it(e){let t=[T.parse,$.parse,A.parse,y.parse,D.parse,U.parse,k.parse,z.parse,E.parse,F.parse];for(let r of t){let n=r(e);if(n!==void 0)return n}}var ye=u.match(/[0-9]+/).desc(["number"]).map(e=>({raw:e,value:parseInt(e,10)})),Se=u.match(/0x[a-fA-F0-9]+/).desc(["hexadecimal number"]).map(e=>({raw:e,value:parseInt(e,16)})),Nr=Se.or(ye).desc(["number"]);var d=class{constructor(){}},f=class extends Error{constructor(r,n,s){super(r,s);this.apgmSpan=n}};function x(e){return e!==void 0?` at line ${e.line} column ${e.column}`:""}var N=class extends d{constructor(r,n,s){super();this.name=r;this.args=n;this.span=s}transform(r){return r(new N(this.name,this.args.map(n=>n.transform(r)),this.span))}pretty(){return`${this.name}(${this.args.map(r=>r.pretty()).join(", ")})`}};var M=class extends d{constructor(r,n,s,i){super();this.modifier=r;this.cond=n;this.thenBody=s;this.elseBody=i}transform(r){return r(new M(this.modifier,this.cond.transform(r),this.thenBody.transform(r),this.elseBody!==void 0?this.elseBody.transform(r):void 0))}pretty(){let r=`if_${this.modifier==="Z"?"z":"nz"}`,n=this.cond.pretty(),s=this.elseBody===void 0?"":` else ${this.elseBody.pretty()}`;return`${r} (${n}) ${this.thenBody.pretty()}`+s}};var B=class extends d{constructor(r){super();this.body=r}transform(r){return r(new B(this.body.transform(r)))}pretty(){return`loop ${this.body.pretty()}`}};var at=class{constructor(t,r,n,s){this.name=t;this.args=r;this.body=n;this.span=s}pretty(){return`macro ${this.name}(${this.args.map(t=>t.pretty()).join(", ")}) ${this.body.pretty()}`}};var ut=class{constructor(t,r,n){this.macros=t;this.headers=r;this.seqExpr=n}pretty(){return[this.macros.map(t=>t.pretty()).join(`
`),this.headers.map(t=>t.toString()).join(`
`),this.seqExpr.prettyInner()].join(`
`)}};var ct=class{constructor(t,r){this.name=t;this.content=r}toString(){let t=this.content.startsWith(" ")?"":" ";return`#${this.name}${t}${this.content}`}};var _=class extends d{constructor(r,n,s){super();this.value=r;this.span=n;this.raw=s}transform(r){return r(this)}pretty(){return this.value.toString()}};var W=class extends d{constructor(r,n){super();this.value=r;this.span=n}transform(r){return r(this)}pretty(){return'"'+this.value+'"'}};var v=class extends d{constructor(r){super();this.exprs=r}transform(r){return r(new v(this.exprs.map(n=>n.transform(r))))}pretty(){return`{${this.prettyInner()}}`}prettyInner(){return this.exprs.map(r=>r instanceof M||r instanceof B||r instanceof L?r.pretty():r.pretty()+";").join(`
`)}};var O=class extends d{constructor(r,n){super();this.name=r;this.span=n}transform(r){return r(this)}pretty(){return this.name}};var L=class extends d{constructor(r,n,s){super();this.modifier=r;this.cond=n;this.body=s}transform(r){return r(new L(this.modifier,this.cond.transform(r),this.body.transform(r)))}pretty(){return`while_${this.modifier==="Z"?"z":"nz"}(${this.cond.pretty()}) ${this.body.pretty()}`}};function we(e,t){let r=t.split(/\n|\r\n/),n=r[e.location.line-2],s=r[e.location.line-1],i=r[e.location.line],a=" ".repeat(Math.max(0,e.location.column-1))+"^",p=[...n===void 0?[]:[n],s],c=[...i===void 0?[]:[i]],P="| ",q=[...p.map(Q=>P+Q)," ".repeat(P.length)+a,...c.map(Q=>P+Q)];return[`parse error at line ${e.location.line} column ${e.location.column}:`,`  expected ${e.expected.join(", ")}`,"",...q].join(`
`)}function Mr(e,t){let r=e.parse(t);if(r.type==="ParseOK")return r.value;throw new f(we(r,t),{start:r.location,end:r.location})}var Pe=u.match(/\/\*(\*(?!\/)|[^*])*\*\//s).desc([]),h=u.match(/\s*/).desc(["space"]).sepBy(Pe).map(()=>{}),Ge=u.match(/\s+/).desc(["space"]),Ne=/[a-zA-Z_][a-zA-Z_0-9]*/u,Br=u.match(Ne).desc(["identifier"]);function pt(e,t){return{start:e,end:{index:e.index+t.length-1,line:e.line,column:e.column+t.length}}}var Me=h.next(Br).skip(h),Be=h.chain(()=>u.location.chain(e=>Br.skip(h).map(t=>[t,pt(e,t)]))),Le=/[a-zA-Z_][a-zA-Z_0-9]*!/u,Lr=h.next(u.match(Le)).skip(h).desc(["macro name"]);function G(e){return h.next(u.text(e)).skip(h)}var Re=G(",").desc(["`,`"]),Rr=G("(").desc(["`(`"]),Tr=G(")").desc(["`)`"]),Te=G(";").desc(["`;`"]),$e=G("{").desc(["`{`"]),ve=G("}").desc(["`}`"]),$r=Be.map(([e,t])=>new O(e,t));function vr(e){return u.lazy(()=>e()).sepBy(Re).wrap(Rr,Tr)}function Ie(){return h.next(u.location).chain(e=>u.choice(Lr,Me).chain(t=>vr(()=>V()).map(r=>new N(t,r,pt(e,t)))))}var De=h.next(u.location.chain(e=>Nr.map(t=>new _(t.value,pt(e,t.raw),t.raw)))).skip(h),_e=h.next(u.location).chain(e=>u.text('"').next(u.match(/[^"]*/)).skip(u.text('"')).skip(h).desc(["string"]).map(t=>({value:t,span:pt(e,`"${t}"`)}))),Oe=_e.map(e=>new W(e.value,e.span));function Ir(){return u.lazy(()=>Ye()).repeat()}function Ce(){return Ir().wrap($e,ve).map(e=>new v(e))}var Ze=u.choice(G("while_z"),G("while_nz")).map(e=>e==="while_z"?"Z":"NZ"),Dr=u.lazy(()=>V()).wrap(Rr,Tr);function _r(){return Ze.chain(e=>Dr.chain(t=>u.lazy(()=>V()).map(r=>new L(e,t,r))))}function Or(){return G("loop").next(u.lazy(()=>V())).map(e=>new B(e))}var Ue=u.choice(G("if_z"),G("if_nz")).map(e=>e==="if_z"?"Z":"NZ");function Cr(){return Ue.chain(e=>Dr.chain(t=>u.lazy(()=>V()).chain(r=>u.choice(G("else").next(u.lazy(()=>V())),u.ok(void 0)).map(n=>new M(e,t,r,n)))))}function or(){return h.chain(t=>u.location.chain(r=>u.text("macro").next(Ge).map(n=>pt(r,"macro")))).and(Lr).chain(([t,r])=>vr(()=>$r).map(n=>({span:t,name:r,args:n})))}function ze(){return or().chain(({span:e,name:t,args:r})=>u.lazy(()=>V()).map(n=>new at(t,r,n,e)))}var ke=u.match(/.*/),Fe=u.text("#").next(u.match(/REGISTERS|COMPONENTS/)).desc(["#REGISTERS","#COMPONENTS"]).chain(e=>ke.map(t=>new ct(e,t))),We=h.next(Fe).skip(h).repeat();function Ve(){return ze().repeat().chain(e=>We.chain(t=>h.next(Ir()).skip(h).map(r=>new ut(e,t,new v(r)))))}function Zr(e){return Mr(Ve(),e)}function V(){return u.choice(Or(),_r(),Cr(),Ie(),Ce(),$r,De,Oe)}function Ye(){return u.choice(Or(),_r(),Cr(),V().skip(Te))}var b=class{constructor(){}};var S=class extends b{constructor(r){super();this.actions=r}transform(r){return r(this)}};var m=class extends b{constructor(r){super();this.exprs=r}transform(r){return r(new m(this.exprs.map(n=>n.transform(r))))}};function X(e){return e instanceof m&&e.exprs.every(t=>X(t))}function $t(e){if(e instanceof S)return e;if(e instanceof m&&e.exprs.length===1){let t=e.exprs[0];return $t(t)}}var I=class extends b{constructor(r,n,s){super();this.cond=r;this.thenBody=n;this.elseBody=s}transform(r){return r(new I(this.cond.transform(r),this.thenBody.transform(r),this.elseBody.transform(r)))}};var C=class extends b{constructor(r){super();this.body=r;this.kind="loop"}transform(r){return r(new C(this.body.transform(r)))}};var Z=class extends b{constructor(r,n,s){super();this.modifier=r;this.cond=n;this.body=s}transform(r){return r(new Z(this.modifier,this.cond.transform(r),this.body.transform(r)))}};var Y=class extends b{constructor(r,n){super();this.level=r;this.span=n;this.kind="break"}transform(r){return r(this)}};var o=class{static incU(t){return o.nonReturn(`INC U${t}`)}static incUMulti(...t){return new S([...t.map(r=>`INC U${r}`),"NOP"])}static tdecU(t){return o.single(`TDEC U${t}`)}static addA1(){return o.nonReturn("ADD A1")}static addB0(){return o.single("ADD B0")}static addB1(){return o.single("ADD B1")}static incB2DX(){return o.nonReturn("INC B2DX")}static tdecB2DX(){return o.single("TDEC B2DX")}static incB2DY(){return o.nonReturn("INC B2DY")}static tdecB2DY(){return o.single("TDEC B2DY")}static readB2D(){return o.single("READ B2D")}static setB2D(){return o.nonReturn("SET B2D")}static incB(t){return o.nonReturn(`INC B${t}`)}static tdecB(t){return o.single(`TDEC B${t}`)}static readB(t){return o.single(`READ B${t}`)}static setB(t){return o.nonReturn(`SET B${t}`)}static haltOUT(){return o.single("HALT_OUT")}static mul0(){return o.single("MUL 0")}static mul1(){return o.single("MUL 1")}static nop(){return o.single("NOP")}static output(t){return o.nonReturn(`OUTPUT ${t}`)}static subA1(){return o.nonReturn("SUB A1")}static subB0(){return o.single("SUB B0")}static subB1(){return o.single("SUB B1")}static nonReturn(t){return new S([t,"NOP"])}static single(t){return new S([t])}};function He(e,t){if(e.args.length!==0)throw new f(`"${e.name}" expects empty argments${x(e.span?.start)}`,e.span);return t}function Ur(e,t){if(e.args.length!==1)throw new f(`number of arguments is not 1: "${e.name}"${x(e.span?.start)}`,e.span);let r=e.args[0];if(!(r instanceof _))throw new f(`argument is not a number: "${e.name}"${x(e.span?.start)}`,e.span);return t(r.value)}function je(e,t){if(e.args.length!==1)throw new f(`number of arguments is not 1: "${e.name}"${x(e.span?.start)}`,e.span);let r=e.args[0];if(!(r instanceof W))throw new f(`argument is not a string: "${e.name}"${x(e.span?.start)}`,e.span);return t(r.value)}var zr=new Map([["nop",o.nop()],["inc_b2dx",o.incB2DX()],["inc_b2dy",o.incB2DY()],["tdec_b2dx",o.tdecB2DX()],["tdec_b2dy",o.tdecB2DY()],["read_b2d",o.readB2D()],["set_b2d",o.setB2D()],["add_a1",o.addA1()],["add_b0",o.addB0()],["add_b1",o.addB1()],["sub_a1",o.subA1()],["sub_b0",o.subB0()],["sub_b1",o.subB1()],["mul_0",o.mul0()],["mul_1",o.mul1()],["halt_out",o.haltOUT()]]),kr=new Map([["inc_u",o.incU],["tdec_u",o.tdecU],["inc_b",o.incB],["tdec_b",o.tdecB],["read_b",o.readB],["set_b",o.setB]]),Fr=new Map([["output",o.output]]);function Xe(e){let t=zr.get(e.name);if(t!==void 0)return He(e,t);let r=kr.get(e.name);if(r!==void 0)return Ur(e,r);let n=Fr.get(e.name);if(n!==void 0)return je(e,n);switch(e.name){case"break":return e.args.length===0?new Y(void 0,e.span):Ur(e,s=>new Y(s,e.span));case"repeat":{if(e.args.length!==2)throw new f(`"repeat" takes two arguments${x(e.span?.start)}`,e.span);let s=e.args[0];if(!(s instanceof _))throw new f(`first argument of "repeat" must be a number${x(e.span?.start)}`,e.span);let i=e.args[1];if(i===void 0)throw new Error("internal error");let a=vt(i);return new m(Array(s.value).fill(0).map(()=>a))}}throw new f(`Unknown ${e.name.endsWith("!")?"macro":"function"}: "${e.name}"${x(e.span?.start)}`,e.span)}function vt(e){let t=vt;if(e instanceof N)return Xe(e);if(e instanceof M)return e.modifier==="Z"?new I(t(e.cond),t(e.thenBody),e.elseBody===void 0?new m([]):t(e.elseBody)):new I(t(e.cond),e.elseBody===void 0?new m([]):t(e.elseBody),t(e.thenBody));if(e instanceof B)return new C(t(e.body));if(e instanceof _)throw new f(`number is not allowed: ${e.raw??e.value}${x(e.span?.start)}`,e.span);if(e instanceof v)return new m(e.exprs.map(r=>t(r)));if(e instanceof W)throw new f(`string is not allowed: ${e.pretty()}${x(e.span?.start)}`,e.span);if(e instanceof O)throw new f(`macro variable is not allowed: variable "${e.name}"${x(e.span?.start)}`,e.span);if(e instanceof L)return new Z(e.modifier,t(e.cond),t(e.body));throw Error("internal error")}function qe(e){let t="",r=!1,n=0;for(;n<e.length;){let s=e[n],i=e[n+1];s==="/"&&i==="*"?(n+=2,r=!0):s==="*"&&i==="/"?(r=!1,n+=2):(r||(t+=s),n++)}return t}function Ke(e){let t=[],r=/(macro\s+([a-zA-Z_][a-zA-Z_0-9]*?!)\s*\(.*?\))/gs,n=qe(e).matchAll(r);for(let s of n){let i=or().parse(s[0]);i.type==="ParseOK"&&t.push({name:i.value.name,args:i.value.args.map(a=>a.name)})}return t}var w=class{constructor(t,r,n){this.input=t;this.output=r;this.inputZNZ=n}},R=class{constructor(t){this.inner=t;if(this.inner.actions.length===0)throw Error("action must be nonempty")}toLineString(){let t=this.inner.prevOutput,r=t;return(t==="*"||t==="Z")&&(r=" "+t),`${this.inner.currentState}; ${r}; ${this.inner.nextState}; ${this.inner.actions.join(", ")}`}},ar=class{constructor(t={}){this.id=0;this.#t=[];this.prefix=t.prefix??"STATE_"}#t;getFreshName(){return this.id++,`${this.prefix}${this.id}`}emitTransition(t,r,n="*"){return new R({currentState:t,prevOutput:n,nextState:r,actions:["NOP"]})}transpile(t){let r="INITIAL",n=this.getFreshName()+"_INITIAL",s=this.emitTransition(r,n,"ZZ"),i=this.prefix+"END",a=this.transpileExpr(new w(n,i,"*"),t),p=new R({currentState:i,prevOutput:"*",nextState:i,actions:["HALT_OUT"]});return[s,...a,p].map(c=>c.toLineString())}transpileExpr(t,r){if(r instanceof S)return[this.transpileActionAPGLExpr(t,r)];if(r instanceof m)return this.transpileSeqAPGLExpr(t,r);if(r instanceof I)return this.transpileIfAPGLExpr(t,r);if(r instanceof C)return this.transpileLoopAPGLExpr(t,r);if(r instanceof Z)return this.transpileWhileAPGLExpr(t,r);if(r instanceof Y)return this.transpileBreakAPGLExpr(t,r);throw Error("unknown expr")}transpileActionAPGLExpr(t,r){return new R({currentState:t.input,prevOutput:t.inputZNZ,nextState:t.output,actions:r.actions})}transpileSeqAPGLExpr(t,r){if(X(r))return[this.emitTransition(t.input,t.output,t.inputZNZ)];if(r.exprs.length===1){let a=r.exprs[0];if(a===void 0)throw new Error("internal error");return this.transpileExpr(t,a)}let n=[],s=t.input,i=r.exprs.length-1;for(let[a,p]of r.exprs.entries())if(a===0){let c=this.getFreshName();n=n.concat(this.transpileExpr(new w(s,c,t.inputZNZ),p)),s=c}else if(a===i)n=n.concat(this.transpileExpr(new w(s,t.output,"*"),p));else{let c=this.getFreshName();n=n.concat(this.transpileExpr(new w(s,c,"*"),p)),s=c}return n}transpileIfAPGLExpr(t,r){if(X(r.thenBody)&&X(r.elseBody))return this.transpileExpr(t,r.cond);let n=this.getFreshName(),s=this.transpileExpr(new w(t.input,n,t.inputZNZ),r.cond),[i,...a]=this.transpileExpr(new w(n,t.output,"Z"),r.thenBody),[p,...c]=this.transpileExpr(new w(n,t.output,"NZ"),r.elseBody);return[...s,i,p,...a,...c]}transpileLoopAPGLExpr(t,r){let{startState:n,fromZOrNZ:s}=this.#r(t);this.#t.push(t.output);let i=this.transpileExpr(new w(n,n,"*"),r.body);return this.#t.pop(),[...s,...i]}transpileWhileAPGLExprBodyEmptyAndSimpleCond(t,r,n){let{startState:s,fromZOrNZ:i}=this.#r(t),a=this.getFreshName(),p=this.transpileActionAPGLExpr(new w(s,a,"*"),r),c=new R({currentState:a,prevOutput:"Z",nextState:n==="Z"?a:t.output,actions:n==="Z"?r.actions:["NOP"]}),P=new R({currentState:a,prevOutput:"NZ",nextState:n==="Z"?t.output:a,actions:n==="Z"?["NOP"]:r.actions});return[...i,p,c,P]}transpileWhileAPGLExprBodyEmpty(t,r,n){let s=$t(r);if(s!==void 0)return this.transpileWhileAPGLExprBodyEmptyAndSimpleCond(t,s,n);let{startState:i,fromZOrNZ:a}=this.#r(t),p=this.getFreshName(),c=this.transpileExpr(new w(i,p,"*"),r),P=new R({currentState:p,prevOutput:"Z",nextState:n==="Z"?i:t.output,actions:["NOP"]}),q=new R({currentState:p,prevOutput:"NZ",nextState:n==="Z"?t.output:i,actions:["NOP"]});return[...a,...c,P,q]}transpileWhileAPGLExpr(t,r){if(X(r.body))return this.transpileWhileAPGLExprBodyEmpty(t,r.cond,r.modifier);let{startState:n,fromZOrNZ:s}=this.#r(t),i=this.getFreshName(),a=this.transpileExpr(new w(n,i,"*"),r.cond),p=this.getFreshName()+"_WHILE_BODY",c=new R({currentState:i,prevOutput:"Z",nextState:r.modifier==="Z"?p:t.output,actions:["NOP"]}),P=new R({currentState:i,prevOutput:"NZ",nextState:r.modifier==="Z"?t.output:p,actions:["NOP"]});this.#t.push(t.output);let q=this.transpileExpr(new w(p,n,"*"),r.body);return this.#t.pop(),[...s,...a,c,P,...q]}#r(t){let r=t.inputZNZ==="*"?t.input:this.getFreshName(),n=t.inputZNZ==="*"?[]:[this.emitTransition(t.input,r,t.inputZNZ)];return{startState:r,fromZOrNZ:n}}transpileBreakAPGLExpr(t,r){let n=r.level??1;if(n<1)throw new f("break level is less than 1",r.span);let s=this.#t[this.#t.length-n];if(s===void 0)throw n===1?new f("break outside while or loop",r.span):new f("break level is greater than number of nests of while or loop",r.span);return[this.emitTransition(t.input,s,t.inputZNZ)]}};function ur(e,t={}){return new ar(t).transpile(e)}function Wr(e){let t=new Set,r=[];for(let n of e)t.has(n)?r.push(n):t.add(n);return r}function Vr(e){return`${e} argument${e===1?"":"s"}`}function Je(){throw new Error("internal error")}function Qe(e,t){let r=t.args;if(r.length!==e.args.length)throw new f(`argument length mismatch: "${e.name}" expect ${Vr(e.args.length)} but given ${Vr(r.length)}${x(t.span?.start)}`,t.span);let n=new Map(e.args.map((s,i)=>[s.name,r[i]??Je()]));return e.body.transform(s=>{if(s instanceof O){let i=n.get(s.name);if(i===void 0)throw new f(`scope error: Unknown variable "${s.name}"${x(s.span?.start)}`,s.span);return i}else return s})}var cr=class{constructor(t){this.count=0;this.maxCount=1e5;if(this.main=t,this.macroMap=new Map(t.macros.map(r=>[r.name,r])),this.macroMap.size<t.macros.length){let n=Wr(t.macros.map(a=>a.name))[0],s=t.macros.slice().reverse().find(a=>a.name===n)?.span,i=s?.start;throw new f(`There is a macro with the same name: "${n}"`+x(i),s)}}expand(){return this.expandExpr(this.main.seqExpr)}expandExpr(t){if(this.maxCount<this.count)throw Error("too many macro expansion");return this.count++,t.transform(r=>this.expandOnce(r))}expandOnce(t){return t instanceof N?this.expandFuncAPGMExpr(t):t}expandFuncAPGMExpr(t){let r=this.macroMap.get(t.name);if(r!==void 0){let n=Qe(r,t);return this.expandExpr(n)}else return t}};function Yr(e){return new cr(e).expand()}function Hr(e){return e.transform(tn)}function tn(e){return e instanceof m?nn(e):e}function rn(e,t){if(e.length===0)return t.slice();if(t.length===0)return e.slice();if(e.some(c=>c instanceof E)||t.some(c=>c instanceof E))return;let r=e.filter(c=>!(c instanceof y)),n=t.filter(c=>!(c instanceof y)),s=r.every(c=>!c.doesReturnValue()),i=n.every(c=>!c.doesReturnValue());if(!s&&!i||!r.every(c=>n.every(P=>!c.isSameComponent(P))))return;let p=r.concat(n);return s&&i&&p.push(new y),p}function en(e){return e.actions.flatMap(t=>{let r=it(t);return r!==void 0?[r]:[]})}function nn(e){let t=[],r=[],n=()=>{r.length!==0&&(t.push(new S(r.map(s=>s.pretty()))),r=[])};for(let s of e.exprs)if(s instanceof S){let i=en(s),a=rn(r,i);a===void 0?(n(),r=i):r=a}else n(),t.push(s);return n(),new m(t)}function jr(e){return e.transform(sn)}function sn(e){return e instanceof m?on(e):e}function on(e){let t=[];for(let r of e.exprs)r instanceof m?t=t.concat(r.exprs):t.push(r);return new m(t)}function ft(e,t,r=void 0){let n=e(t);return r!==void 0&&console.log(r,JSON.stringify(n,null,"  ")),n}function _u(e,t={},r=!1){let n=ft(Zr,e,r?"apgm":void 0),s=ft(Yr,n,r?"apgm expaned":void 0),i=ft(vt,s,r?"apgl":void 0),a=ft(jr,i,r?"optimized apgl seq":void 0),p=ft(Hr,a,r?"optimized apgl action":void 0),c=ur(p,t),P=["# State    Input    Next state    Actions","# ---------------------------------------"];return n.headers.map(Q=>Q.toString()).concat(P,c)}export{Ke as completionParser,zr as emptyArgFuncs,_u as integration,kr as numArgFuncs,Fr as strArgFuncs};
