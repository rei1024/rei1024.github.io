var Ee=Object.defineProperty;var Se=(t,r)=>{for(var e in r)Ee(t,e,{get:r[e],enumerable:!0})};var a={};Se(a,{Parser:()=>v,all:()=>Mr,choice:()=>Ge,eof:()=>Nr,fail:()=>ye,lazy:()=>Ne,location:()=>Ht,match:()=>we,ok:()=>ut,text:()=>Pe});var v=class J{constructor(r){this.action=r}parse(r){let e={index:0,line:1,column:1},n=new Be({input:r,location:e}),o=this.skip(Nr).action(n);return o.type==="ActionOK"?{type:"ParseOK",value:o.value}:{type:"ParseFail",location:o.furthest,expected:o.expected}}tryParse(r){let e=this.parse(r);if(e.type==="ParseOK")return e.value;let{expected:n,location:o}=e,{line:s,column:i}=o,c=`parse error at line ${s} column ${i}: expected ${n.join(", ")}`;throw new Error(c)}and(r){return new J(e=>{let n=this.action(e);if(n.type==="ActionFail")return n;e=e.moveTo(n.location);let o=e.merge(n,r.action(e));if(o.type==="ActionOK"){let s=[n.value,o.value];return e.merge(o,e.ok(o.location.index,s))}return o})}skip(r){return this.and(r).map(([e])=>e)}next(r){return this.and(r).map(([,e])=>e)}or(r){return new J(e=>{let n=this.action(e);return n.type==="ActionOK"?n:e.merge(n,r.action(e))})}chain(r){return new J(e=>{let n=this.action(e);if(n.type==="ActionFail")return n;let o=r(n.value);return e=e.moveTo(n.location),e.merge(n,o.action(e))})}map(r){return this.chain(e=>ut(r(e)))}thru(r){return r(this)}desc(r){return new J(e=>{let n=this.action(e);return n.type==="ActionOK"?n:{type:"ActionFail",furthest:n.furthest,expected:r}})}wrap(r,e){return r.next(this).skip(e)}trim(r){return this.wrap(r,r)}repeat(r=0,e=1/0){if(!Gr(r,e))throw new Error(`repeat: bad range (${r} to ${e})`);return r===0?this.repeat(1,e).or(ut([])):new J(n=>{let o=[],s=this.action(n);if(s.type==="ActionFail")return s;for(;s.type==="ActionOK"&&o.length<e;){if(o.push(s.value),s.location.index===n.location.index)throw new Error("infinite loop detected; don't call .repeat() with parsers that can accept zero characters");n=n.moveTo(s.location),s=n.merge(s,this.action(n))}return s.type==="ActionFail"&&o.length<r?s:n.merge(s,n.ok(n.location.index,o))})}sepBy(r,e=0,n=1/0){if(!Gr(e,n))throw new Error(`sepBy: bad range (${e} to ${n})`);return e===0?this.sepBy(r,1,n).or(ut([])):n===1?this.map(o=>[o]):this.chain(o=>r.next(this).repeat(e-1,n-1).map(s=>[o,...s]))}node(r){return Mr(Ht,this,Ht).map(([e,n,o])=>({type:"ParseNode",name:r,value:n,start:e,end:o}))}};function Gr(t,r){return t<=r&&t>=0&&r>=0&&Number.isInteger(t)&&t!==1/0&&(Number.isInteger(r)||r===1/0)}var Ht=new v(t=>t.ok(t.location.index,t.location));function ut(t){return new v(r=>r.ok(r.location.index,t))}function ye(t){return new v(r=>r.fail(r.location.index,t))}var Nr=new v(t=>t.location.index<t.input.length?t.fail(t.location.index,["<EOF>"]):t.ok(t.location.index,"<EOF>"));function Pe(t){return new v(r=>{let e=r.location.index,n=e+t.length;return r.input.slice(e,n)===t?r.ok(n,t):r.fail(e,[t])})}function we(t){for(let e of t.flags)switch(e){case"i":case"s":case"m":case"u":continue;default:throw new Error("only the regexp flags 'imsu' are supported")}let r=new RegExp(t.source,t.flags+"y");return new v(e=>{let n=e.location.index;r.lastIndex=n;let o=e.input.match(r);if(o){let s=n+o[0].length,i=e.input.slice(n,s);return e.ok(s,i)}return e.fail(n,[String(t)])})}function Mr(...t){return t.reduce((r,e)=>r.chain(n=>e.map(o=>[...n,o])),ut([]))}function Ge(...t){return t.reduce((r,e)=>r.or(e))}function Ne(t){let r=new v(e=>(r.action=t().action,r.action(e)));return r}function Me(t,r){return[...new Set([...t,...r])]}var Be=class Br{constructor(r){this.input=r.input,this.location=r.location}moveTo(r){return new Br({input:this.input,location:r})}_internal_move(r){if(r===this.location.index)return this.location;let e=this.location.index,n=r,o=this.input.slice(e,n),{line:s,column:i}=this.location;for(let c of o)c===`
`?(s++,i=1):i++;return{index:r,line:s,column:i}}ok(r,e){return{type:"ActionOK",value:e,location:this._internal_move(r),furthest:{index:-1,line:-1,column:-1},expected:[]}}fail(r,e){return{type:"ActionFail",furthest:this._internal_move(r),expected:e}}merge(r,e){if(e.furthest.index>r.furthest.index)return e;let n=e.furthest.index===r.furthest.index?Me(r.expected,e.expected):r.expected;return e.type==="ActionOK"?{type:"ActionOK",location:e.location,value:e.value,furthest:r.furthest,expected:n}:{type:"ActionFail",furthest:r.furthest,expected:n}}};var f=class{pretty(){return""}doesReturnValue(){return!1}isSameComponent(r){return!0}};var Vt="A1",Yt="B0",Xt="B1",Lr="ADD",Le=t=>{switch(t){case 0:return Vt;case 1:return Yt;case 2:return Xt}},Te=t=>{switch(t){case Vt:return 0;case Yt:return 1;case Xt:return 2}},Q=class t extends f{constructor(r){super(),this.op=r}pretty(){return`${Lr} ${Le(this.op)}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(n===Lr&&(o===Vt||o===Yt||o===Xt))return new t(Te(o))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(r){return r instanceof t}};var Lt="INC",jt="TDEC",Tt="READ",$t="SET",qt="B2DX",Kt="B2DY",Jt="B2D",$e="DEC",Tr="SQX",$r="SQY",Rr="SQ",Dr=t=>{switch(t){case Lt:return 0;case jt:return 1;case Tt:return 2;case $t:return 3}},Re=t=>{switch(t){case 0:return Lt;case 1:return jt;case 2:return Tt;case 3:return $t}},vr=t=>{switch(t){case qt:return 4;case Kt:return 5;case Jt:return 6}},De=t=>{switch(t){case 4:return qt;case 5:return Kt;case 6:return Jt}},dt=class t extends f{constructor(r,e){super(),this.op=r,this.axis=e}pretty(){return`${Re(this.op)} ${De(this.axis)}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(!(n===void 0||o===void 0)){if(n===Lt||n===jt){if(o===qt||o===Kt)return new t(Dr(n),vr(o))}else if((n===Tt||n===$t)&&o===Jt)return new t(Dr(n),vr(o));switch(n){case Lt:switch(o){case Tr:return new t(0,4);case $r:return new t(0,5);default:return}case $e:switch(o){case Tr:return new t(1,4);case $r:return new t(1,5);default:return}case Tt:switch(o){case Rr:return new t(2,6);default:return}case $t:switch(o){case Rr:return new t(3,6);default:return}}}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(r){if(r instanceof t){let e=this.axis,n=r.axis;return e===4&&n===5?!1:!(e===5&&n===4)}return!1}};var Qt="INC",tr="TDEC",rr="READ",er="SET",Ir="B",ve=t=>{switch(t){case 0:return Qt;case 1:return tr;case 2:return rr;case 3:return er}},Ie=t=>{switch(t){case Qt:return 0;case tr:return 1;case rr:return 2;case er:return 3}},I=class t extends f{constructor(r,e){super(),this.op=r,this.regNumber=e,this.registerCache=void 0}pretty(){return`${ve(this.op)} ${Ir}${this.regNumber}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(!(n===void 0||o===void 0)&&(n===Qt||n===tr||n===rr||n===er)&&o.startsWith(Ir)){let s=o.slice(1);if(/^[0-9]+$/u.test(s))return new t(Ie(n),parseInt(s,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(r){return r instanceof t?this.regNumber===r.regNumber:!1}};var _r="HALT_OUT",b=class t extends f{constructor(){super()}pretty(){return _r}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==1)return;let[n]=e;if(n===_r)return new t}doesReturnValue(){return!1}isSameComponent(r){return r instanceof t}};var sr="0",ir="1",Or="MUL",_e=t=>{switch(t){case sr:return 0;case ir:return 1}},Oe=t=>{switch(t){case 0:return sr;case 1:return ir}},At=class t extends f{constructor(r){super(),this.op=r}pretty(){return`${Or} ${Oe(this.op)}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(n===Or&&(o===sr||o===ir))return new t(_e(o))}doesReturnValue(){return!0}isSameComponent(r){return r instanceof t}};var Cr="NOP",w=class t extends f{constructor(){super()}pretty(){return Cr}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==1)return;let[n]=e;if(n===Cr)return new t}doesReturnValue(){return!0}isSameComponent(r){return r instanceof t}};var Zr="OUTPUT",gt=class t extends f{constructor(r){super(),this.digit=r}pretty(){return`${Zr} ${this.digit}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(n===Zr&&o!==void 0)return new t(o)}doesReturnValue(){return!1}isSameComponent(r){return r instanceof t}};var ar="A1",cr="B0",pr="B1",zr="SUB",Ce=t=>{switch(t){case 0:return ar;case 1:return cr;case 2:return pr}},Ze=t=>{switch(t){case ar:return 0;case cr:return 1;case pr:return 2}},bt=class t extends f{constructor(r){super(),this.op=r}pretty(){return`${zr} ${Ce(this.op)}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(n===zr&&(o===ar||o===cr||o===pr))return new t(Ze(o))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(r){return r instanceof t}};var ur="INC",mr="TDEC",Ur="U",ze="R",Ue=t=>{switch(t){case 0:return ur;case 1:return mr}},ke=t=>{switch(t){case ur:return 0;case mr:return 1}},_=class t extends f{constructor(r,e){super(),this.op=r,this.regNumber=e,this.registerCache=void 0}pretty(){return`${Ue(this.op)} ${Ur}${this.regNumber}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(!(n===void 0||o===void 0)&&(n===ur||n===mr)&&(o.startsWith(Ur)||o.startsWith(ze))){let s=o.slice(1);if(/^[0-9]+$/u.test(s))return new t(ke(n),parseInt(s,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0}}isSameComponent(r){return r instanceof t?this.regNumber===r.regNumber:!1}};var fr="INC",lr="DEC",dr="READ",hr="SET",xr="RESET",Fe=t=>{switch(t){case 0:return fr;case 1:return lr;case 2:return dr;case 3:return hr;case 4:return xr}},We=t=>{switch(t){case fr:return 0;case lr:return 1;case dr:return 2;case hr:return 3;case xr:return 4}},et=class t extends f{constructor(r,e){super(),this.op=r,this.regNumber=e}pretty(){return`${Fe(this.op)} T${this.regNumber}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(!(n===void 0||o===void 0)&&(n===fr||n===lr||n===dr||n===hr||n===xr)&&o.startsWith("T")){let s=o.slice(1);if(/^[0-9]+$/u.test(s))return new t(We(n),parseInt(s,10))}}doesReturnValue(){switch(this.op){case 0:return!0;case 1:return!0;case 2:return!0;case 3:return!1;case 4:return!1}}isSameComponent(r){return r instanceof t?this.regNumber===r.regNumber:!1}};var H=t=>{let r=[I.parse,_.parse,dt.parse,w.parse,Q.parse,At.parse,bt.parse,gt.parse,b.parse,et.parse];for(let e of r){let n=e(t);if(n!==void 0)return n}};var E=()=>{throw Error("internal error")};var V=class{pretty(){return""}},nt=class t extends V{constructor(r){super(),this.content=r}static get key(){return"#COMPONENTS"}pretty(){return t.key+" "+this.content}},ot=class t extends V{constructor(r){super(),this.content=r}static get key(){return"#REGISTERS"}pretty(){return t.key+" "+this.content}},Ar=class extends V{constructor(r){super(),this.str=r}getString(){return this.str}pretty(){return this.getString()}},gr=class extends V{constructor(){super()}pretty(){return""}},He=t=>{switch(t){case"Z":return t;case"NZ":return t;case"ZZ":return t;case"*":return t;default:return}},Y=class extends V{constructor({state:r,input:e,nextState:n,actions:o,line:s}){super(),this.state=r,this.input=e,this.nextState=n,this.actions=o,this.line=s,this._string=`${this.state}; ${this.input}; ${this.nextState}; ${this.actions.map(i=>i.pretty()).join(", ")}`}pretty(){return this._string}},kr=(t,r)=>{let e=t.trim();if(e==="")return new gr;if(e.startsWith("#"))return e.startsWith(nt.key)?new nt(e.slice(nt.key.length).trim()):e.startsWith(ot.key)?new ot(e.slice(ot.key.length).trim()):new Ar(t);let n=e.split(/\s*;\s*/u);if(n.length<4)return`Invalid line "${t}"${St(r)}`;if(n.length>4)return n[4]===""?`Extraneous semicolon "${t}"${St(r)}`:`Invalid line "${t}"${St(r)}`;let o=n[0]??E(),s=n[1]??E(),i=n[2]??E(),p=(n[3]??E()).trim().split(/\s*,\s*/u).filter(N=>N!==""),x=[];for(let N of p){let ct=H(N);if(ct===void 0)return`Unknown action "${N}" in "${t}"${St(r)}`;x.push(ct)}let y=He(s);return y===void 0?`Unknown input "${s}" in "${t}"${St(r)}. Expect "Z", "NZ", "ZZ" or "*"`:new Y({state:o,input:y,nextState:i,actions:x,line:r})},St=t=>t!==void 0?` at line ${t}`:"";var xi=Number.parseInt,Ai=Number.isNaN;var st=class t{constructor(r){this.array=r}getArray(){return this.array}pretty(){return this.array.map(r=>r.pretty()).join(`
`)}static parse(r){let n=r.split(/\r\n|\n|\r/u).map((i,c)=>kr(i,c+1)),o=n.flatMap(i=>typeof i=="string"?[i]:[]);if(o.length>0)return o.join(`
`);let s=n.flatMap(i=>typeof i!="string"?[i]:[]);return new t(s)}};function br(t){let r=t.getArray(),e=r.flatMap(s=>s instanceof Y?[s]:[]),n=e.reduce((s,i)=>Math.max(s,i.state.length),0),o=e.reduce((s,i)=>Math.max(s,i.nextState.length),0);return r.map(s=>{if(s instanceof Y){let i=n-s.state.length,c=2-s.input.length,p=o-s.nextState.length;return`${s.state}; ${" ".repeat(i)}${s.input}; ${" ".repeat(c)}${s.nextState}; ${" ".repeat(p)}${s.actions.map(x=>x.pretty()).join(", ")}`}else return s.pretty()}).join(`
`)}function Fr(t){let r=st.parse(t);if(typeof r=="string")throw new Error(r);return br(r)}var Xe=a.match(/[0-9]+/).desc(["number"]).map(t=>({raw:t,value:parseInt(t,10)})),je=a.match(/0x[a-fA-F0-9]+/).desc(["hexadecimal number"]).map(t=>({raw:t,value:parseInt(t,16)})),Wr=je.or(Xe).desc(["number"]);var d=class{constructor(){}},u=class extends Error{constructor(e,n,o){super(e,o);this.apgmSpan=n}};function Hr(t){return`line ${t.line} column ${t.column}`}function A(t){return t!==void 0?` at ${Hr(t)}`:""}var B=class t extends d{constructor(e,n,o){super();this.name=e;this.args=n;this.span=o}transform(e){return e(new t(this.name,this.args.map(n=>n.transform(e)),this.span))}pretty(){return`${this.name}(${this.args.map(e=>e.pretty()).join(", ")})`}};var L=class t extends d{constructor(e,n,o,s,i){super();this.modifier=e;this.cond=n;this.thenBody=o;this.elseBody=s;this.span=i}transform(e){return e(new t(this.modifier,this.cond.transform(e),this.thenBody.transform(e),this.elseBody!==void 0?this.elseBody.transform(e):void 0,this.span))}pretty(){let e=`if_${this.modifier==="Z"?"z":"nz"}`,n=this.cond.pretty(),o=this.elseBody===void 0?"":` else ${this.elseBody.pretty()}`;return`${e} (${n}) ${this.thenBody.pretty()}`+o}};var T=class t extends d{constructor(e){super();this.body=e}transform(e){return e(new t(this.body.transform(e)))}pretty(){return`loop ${this.body.pretty()}`}};var Pt=class{constructor(r,e,n,o){this.name=r;this.args=e;this.body=n;this.span=o}pretty(){return`macro ${this.name}(${this.args.map(r=>r.pretty()).join(", ")}) ${this.body.pretty()}`}};var wt=class{constructor(r,e,n){this.macros=r;this.headers=e;this.seqExpr=n}pretty(){return[this.macros.map(r=>r.pretty()).join(`
`),this.headers.map(r=>r.toString()).join(`
`),this.seqExpr.prettyInner()].join(`
`)}};var Gt=class{constructor(r,e){this.name=r;this.content=e}toString(){let r=this.content.startsWith(" ")?"":" ";return`#${this.name}${r}${this.content}`}};var $=class extends d{constructor(e,n,o){super();this.value=e;this.span=n;this.raw=o}transform(e){return e(this)}pretty(){return this.value.toString()}};var O=class extends d{constructor(e,n){super();this.value=e;this.span=n}transform(e){return e(this)}pretty(){return'"'+this.value+'"'}};var C=class t extends d{constructor(e){super();this.exprs=e}transform(e){return e(new t(this.exprs.map(n=>n.transform(e))))}pretty(){return`{${this.prettyInner()}}`}prettyInner(){return this.exprs.map(e=>e instanceof L||e instanceof T||e instanceof R?e.pretty():e.pretty()+";").join(`
`)}};var D=class extends d{constructor(e,n){super();this.name=e;this.span=n}transform(e){return e(this)}pretty(){return this.name}};var R=class t extends d{constructor(e,n,o){super();this.modifier=e;this.cond=n;this.body=o}transform(e){return e(new t(this.modifier,this.cond.transform(e),this.body.transform(e)))}pretty(){return`while_${this.modifier==="Z"?"z":"nz"}(${this.cond.pretty()}) ${this.body.pretty()}`}};function Ft(t,r){let e=r.split(/\r?\n/),n=e[t.line-2],o=e[t.line-1],s=e[t.line],i=" ".repeat(Math.max(0,t.column-1))+"^",c=n===void 0?[]:[n],p=s===void 0?[]:[s],x=" | ",y=t.line.toString(),N=" ".repeat(y.length);return[...c.map(pt=>N+x+pt),y+x+o,N+x+i,...p.map(pt=>N+x+pt)]}function qe(t,r){let e=Ft(t.location,r);return[`Error: Parse error at line ${t.location.line} column ${t.location.column}:`,`  expected ${t.expected.join(", ")}`,"",...e].join(`
`)}function Vr(t,r){let e=t.parse(r);if(e.type==="ParseOK")return e.value;throw new u(qe(e,r),{start:e.location,end:e.location})}function Z(t,r){let e=r.length;return{start:t,end:{index:t.index+e-1,line:t.line,column:t.column+e}}}var Yr=a.location.chain(t=>a.text('"').next(a.match(/[^"]*/)).skip(a.text('"')).desc(["string"]).map(r=>({value:r,span:Z(t,`"${r}"`)})));var Ke=a.match(/\/\*(\*(?!\/)|[^*])*\*\//s).desc([]),l=a.match(/\s*/).desc(["space"]).sepBy(Ke).map(()=>{}),Je=a.match(/\s+/).desc(["space"]),Qe=/[a-zA-Z_][a-zA-Z_0-9]*/u,qr=a.match(Qe).desc(["identifier"]),tn=qr.wrap(l,l),rn=l.chain(()=>a.location.chain(t=>qr.skip(l).map(r=>[r,Z(t,r)]))),en=/[a-zA-Z_][a-zA-Z_0-9]*!/u,Kr=a.match(en).wrap(l,l).desc(["macro name"]);function M(t){return a.text(t).wrap(l,l)}function Xr(t){return a.location.chain(e=>a.text(t).map(n=>[n,Z(e,t)])).wrap(l,l)}var nn=M(",").desc(["`,`"]),Jr=M("(").desc(["`(`"]),Qr=M(")").desc(["`)`"]),on=M(";").desc(["`;`"]),sn=M("{").desc(["`{`"]),an=M("}").desc(["`}`"]),te=rn.map(([t,r])=>new D(t,r));function re(t){return a.lazy(()=>t()).sepBy(nn).wrap(Jr,Qr)}function cn(){return l.next(a.location).chain(t=>a.choice(Kr,tn).chain(r=>re(()=>z()).map(e=>new B(r,e,Z(t,r)))))}var pn=a.location.chain(t=>Wr.map(r=>new $(r.value,Z(t,r.raw),r.raw))).wrap(l,l),un=Yr.wrap(l,l).map(t=>new O(t.value,t.span)),ee=a.lazy(()=>bn()).repeat(),mn=ee.wrap(sn,an).map(t=>new C(t)),fn=a.choice(M("while_z"),M("while_nz")).map(t=>t==="while_z"?"Z":"NZ"),ne=a.lazy(()=>z()).wrap(Jr,Qr),oe=fn.chain(t=>ne.chain(r=>z().map(e=>new R(t,r,e)))),se=M("loop").next(a.lazy(()=>z())).map(t=>new T(t)),ln=a.choice(Xr("if_z"),Xr("if_nz")).map(t=>t[0]==="if_z"?["Z",t[1]]:["NZ",t[1]]),ie=ln.chain(([t,r])=>ne.chain(e=>a.lazy(()=>z()).chain(n=>a.choice(M("else").next(a.lazy(()=>z())),a.ok(void 0)).map(o=>new L(t,e,n,o,r))))),jr="macro",dn=l.chain(t=>a.location.chain(r=>a.text(jr).next(Je).map(e=>Z(r,jr))));function Er(){return dn.and(Kr).chain(([t,r])=>re(()=>te).map(e=>({span:t,name:r,args:e})))}function hn(){return Er().chain(({span:t,name:r,args:e})=>a.lazy(()=>z()).map(n=>new Pt(r,e,n,t)))}var xn=a.match(/.*/),An=a.text("#").next(a.match(/REGISTERS|COMPONENTS/)).desc(["#REGISTERS","#COMPONENTS"]).chain(t=>xn.map(r=>new Gt(t,r))),gn=An.wrap(l,l).repeat();function z(){return a.choice(se,oe,ie,a.lazy(()=>cn()),mn,te,pn,un)}function bn(){return a.choice(se,oe,ie,z().skip(on))}function En(){return hn().repeat().chain(t=>gn.chain(r=>ee.wrap(l,l).map(e=>new wt(t,r,new C(e)))))}function ae(t){return Vr(En(),t)}var g=class{constructor(){}};var S=class extends g{constructor(e){super();this.actions=e}transform(e){return e(this)}};var h=class t extends g{constructor(e){super();this.exprs=e}transform(e){return e(new t(this.exprs.map(n=>n.transform(e))))}};function X(t){return t instanceof h&&t.exprs.every(r=>X(r))}function it(t){if(t instanceof S)return t;if(t instanceof h&&t.exprs.length===1){let r=t.exprs[0];return it(r)}}var U=class t extends g{constructor(e,n,o){super();this.cond=e;this.thenBody=n;this.elseBody=o}transform(e){return e(new t(this.cond.transform(e),this.thenBody.transform(e),this.elseBody.transform(e)))}};var j=class t extends g{constructor(e){super();this.body=e}kind="loop";transform(e){return e(new t(this.body.transform(e)))}};var q=class t extends g{constructor(e,n,o){super();this.modifier=e;this.cond=n;this.body=o}transform(e){return e(new t(this.modifier,this.cond.transform(e),this.body.transform(e)))}};var k=class extends g{constructor(e,n){super();this.level=e;this.span=n}kind="break";transform(e){return e(this)}};var m=class t{static incU(r){return t.nonReturn(`INC U${r}`)}static incUMulti(...r){return new S([...r.map(e=>`INC U${e}`),"NOP"])}static tdecU(r){return t.single(`TDEC U${r}`)}static addA1(){return t.nonReturn("ADD A1")}static addB0(){return t.single("ADD B0")}static addB1(){return t.single("ADD B1")}static incB2DX(){return t.nonReturn("INC B2DX")}static tdecB2DX(){return t.single("TDEC B2DX")}static incB2DY(){return t.nonReturn("INC B2DY")}static tdecB2DY(){return t.single("TDEC B2DY")}static readB2D(){return t.single("READ B2D")}static setB2D(){return t.nonReturn("SET B2D")}static incB(r){return t.nonReturn(`INC B${r}`)}static tdecB(r){return t.single(`TDEC B${r}`)}static readB(r){return t.single(`READ B${r}`)}static setB(r){return t.nonReturn(`SET B${r}`)}static haltOUT(){return t.single("HALT_OUT")}static mul0(){return t.single("MUL 0")}static mul1(){return t.single("MUL 1")}static nop(){return t.single("NOP")}static output(r){return t.nonReturn(`OUTPUT ${r}`)}static subA1(){return t.nonReturn("SUB A1")}static subB0(){return t.single("SUB B0")}static subB1(){return t.single("SUB B1")}static nonReturn(r){return new S([r,"NOP"])}static single(r){return new S([r])}};function Sn(t,r){if(t.args.length!==0)throw new u(`"${t.name}" expects empty argments${A(t.span?.start)}`,t.span);return r}function ce(t,r){if(t.args.length!==1)throw new u(`number of arguments is not 1: "${t.name}"${A(t.span?.start)}`,t.span);let e=t.args[0];if(!(e instanceof $))throw new u(`argument is not a number: "${t.name}"${A(t.span?.start)}`,t.span);return r(e.value)}function yn(t,r){if(t.args.length!==1)throw new u(`number of arguments is not 1: "${t.name}"${A(t.span?.start)}`,t.span);let e=t.args[0];if(!(e instanceof O))throw new u(`argument is not a string: "${t.name}"${A(t.span?.start)}`,t.span);return r(e.value)}var pe=new Map([["nop",m.nop()],["inc_b2dx",m.incB2DX()],["inc_b2dy",m.incB2DY()],["tdec_b2dx",m.tdecB2DX()],["tdec_b2dy",m.tdecB2DY()],["read_b2d",m.readB2D()],["set_b2d",m.setB2D()],["add_a1",m.addA1()],["add_b0",m.addB0()],["add_b1",m.addB1()],["sub_a1",m.subA1()],["sub_b0",m.subB0()],["sub_b1",m.subB1()],["mul_0",m.mul0()],["mul_1",m.mul1()],["halt_out",m.haltOUT()]]),ue=new Map([["inc_u",m.incU],["tdec_u",m.tdecU],["inc_b",m.incB],["tdec_b",m.tdecB],["read_b",m.readB],["set_b",m.setB]]),me=new Map([["output",m.output]]);function Pn(t){let r=pe.get(t.name);if(r!==void 0)return Sn(t,r);let e=ue.get(t.name);if(e!==void 0)return ce(t,e);let n=me.get(t.name);if(n!==void 0)return yn(t,n);switch(t.name){case"break":return t.args.length===0?new k(void 0,t.span):ce(t,o=>new k(o,t.span));case"repeat":{if(t.args.length!==2)throw new u(`"repeat" takes two arguments${A(t.span?.start)}`,t.span);let o=t.args[0];if(!(o instanceof $))throw new u(`first argument of "repeat" must be a number${A(t.span?.start)}`,t.span);let s=t.args[1];if(s===void 0)throw new Error("internal error");let i=Wt(s);return new h(Array(o.value).fill(0).map(()=>i))}}throw new u(`Unknown ${t.name.endsWith("!")?"macro":"function"}: "${t.name}"${A(t.span?.start)}`,t.span)}function Wt(t){let r=Wt;if(t instanceof B)return Pn(t);if(t instanceof L)return t.modifier==="Z"?new U(r(t.cond),r(t.thenBody),t.elseBody===void 0?new h([]):r(t.elseBody)):new U(r(t.cond),t.elseBody===void 0?new h([]):r(t.elseBody),r(t.thenBody));if(t instanceof T)return new j(r(t.body));if(t instanceof $)throw new u(`number is not allowed: ${t.raw??t.value}${A(t.span?.start)}`,t.span);if(t instanceof C)return new h(t.exprs.map(e=>r(e)));if(t instanceof O)throw new u(`string is not allowed: ${t.pretty()}${A(t.span?.start)}`,t.span);if(t instanceof R)return new q(t.modifier,r(t.cond),r(t.body));throw t instanceof D?new u(`macro variable is not allowed: variable "${t.name}"${A(t.span?.start)}`,t.span):Error("internal error")}function wn(t){let r="",e=!1,n=0;for(;n<t.length;){let o=t[n],s=t[n+1];o==="/"&&s==="*"?(n+=2,e=!0):o==="*"&&s==="/"?(e=!1,n+=2):(e||(r+=o),n++)}return r}function Gn(t){let r=[],e=/(macro\s+([a-zA-Z_][a-zA-Z_0-9]*?!)\s*\(.*?\))/gs,n=wn(t).matchAll(e);for(let o of n){let s=Er().parse(o[0]);s.type==="ParseOK"&&r.push({name:s.value.name,args:s.value.args.map(i=>i.name)})}return r}function fe(t){return t.transform(Nn)}function Nn(t){return t instanceof h?Bn(t):t}function le(t,r){let e=de(Sr(t),Sr(r));return e===void 0?void 0:he(e)}var Mn=new w;function de(t,r){if(t.length===0)return r.slice();if(r.length===0)return t.slice();if(t.some(p=>p instanceof b)||r.some(p=>p instanceof b))return;let e=t.filter(p=>!(p instanceof w)),n=r.filter(p=>!(p instanceof w)),o=e.every(p=>!p.doesReturnValue()),s=n.every(p=>!p.doesReturnValue());if(!o&&!s||!e.every(p=>n.every(x=>!p.isSameComponent(x))))return;let c=e.concat(n);return o&&s&&c.push(Mn),c}function Sr(t){return t.actions.flatMap(r=>{let e=H(r);return e!==void 0?[e]:[]})}function he(t){return new S(t.map(r=>r.pretty()))}function Bn(t){let r=[],e=[],n=()=>{e.length!==0&&(r.push(he(e)),e=[])};for(let o of t.exprs)if(o instanceof S){let s=Sr(o),i=de(e,s);i===void 0?(n(),e=s):e=i}else n(),r.push(o);return n(),new h(r)}var P=class{constructor(r,e,n){this.input=r;this.output=e;this.inputZNZ=n}};function Ln(t){let r=t.prevOutput,e=r;return(r==="*"||r==="Z")&&(e=" "+r),`${t.currentState}; ${e}; ${t.nextState}; ${t.actions.join(", ")}`}var G=class{constructor(r){this.inner=r;if(this.inner.actions.length===0)throw Error("actions must be nonempty")}},yr=class{#o=0;#e=[];#n;#s;constructor(r={}){this.#n=r.prefix??"STATE_",this.#s=!(r.noOptimize??!1)}#r(){return this.#o++,`${this.#n}${this.#o}`}#i(r,e,n="*"){return new G({currentState:r,prevOutput:n,nextState:e,actions:["NOP"]})}transpile(r){let e="INITIAL",n=this.#r(),o=this.#i(e,n,"ZZ"),s=this.#n+"END",i=this.#t(new P(n,s,"*"),r),c=new G({currentState:s,prevOutput:"*",nextState:s,actions:["HALT_OUT"]});return[o,...i,c].map(p=>Ln(p.inner))}#t(r,e){if(e instanceof S)return[this.#c(r,e)];if(e instanceof h)return this.#u(r,e);if(e instanceof U)return this.#m(r,e);if(e instanceof j)return this.#f(r,e);if(e instanceof q)return this.#d(r,e);if(e instanceof k)return this.#h(r,e);throw Error("unknown expr")}#c(r,e){return new G({currentState:r.input,prevOutput:r.inputZNZ,nextState:r.output,actions:e.actions})}#u(r,e){if(X(e))return[this.#i(r.input,r.output,r.inputZNZ)];if(e.exprs.length===1){let i=e.exprs[0];if(i===void 0)throw new Error("internal error");return this.#t(r,i)}let n=[],o=r.input,s=e.exprs.length-1;for(let[i,c]of e.exprs.entries())if(i!==s){let p=this.#r();n=n.concat(this.#t(new P(o,p,i===0?r.inputZNZ:"*"),c)),o=p}else n=n.concat(this.#t(new P(o,r.output,"*"),c));return n}#m(r,e){if(this.#s&&X(e.thenBody)&&X(e.elseBody))return this.#t(r,e.cond);let n=this.#r(),o=this.#t(new P(r.input,n,r.inputZNZ),e.cond),[s,...i]=this.#t(new P(n,r.output,"Z"),e.thenBody),[c,...p]=this.#t(new P(n,r.output,"NZ"),e.elseBody);return[...o,s,c,...i,...p]}#f(r,e){let{startState:n,fromZOrNZ:o}=this.#a(r);this.#e.push(r.output);let s=this.#t(new P(n,n,"*"),e.body);return this.#e.pop(),[...o,...s]}#p(r,e,n,o){let{startState:s,fromZOrNZ:i}=this.#a(r),c=this.#r(),p=this.#c(new P(s,c,"*"),e),x=new G({currentState:c,prevOutput:"Z",nextState:o==="Z"?c:r.output,actions:o==="Z"?n.actions:["NOP"]}),y=new G({currentState:c,prevOutput:"NZ",nextState:o==="Z"?r.output:c,actions:o==="Z"?["NOP"]:n.actions});return[...i,p,x,y]}#l(r,e,n){let{startState:o,fromZOrNZ:s}=this.#a(r),i=this.#r(),c=this.#t(new P(o,i,"*"),e),p=new G({currentState:i,prevOutput:"Z",nextState:n==="Z"?o:r.output,actions:["NOP"]}),x=new G({currentState:i,prevOutput:"NZ",nextState:n==="Z"?r.output:o,actions:["NOP"]});return[...s,...c,p,x]}#d(r,e){let n=this.#s;if(n&&X(e.body)){let K=it(e.cond);return K!==void 0?this.#p(r,K,K,e.modifier):this.#l(r,e.cond,e.modifier)}let o=it(e.body),s=it(e.cond);if(n&&s!==void 0&&o!==void 0){let K=le(o,s);if(K!==void 0)return this.#p(r,s,K,e.modifier)}let{startState:i,fromZOrNZ:c}=this.#a(r),p=this.#r(),x=this.#t(new P(i,p,"*"),e.cond),y=this.#r()+"_WHILE_BODY",N=new G({currentState:p,prevOutput:"Z",nextState:e.modifier==="Z"?y:r.output,actions:["NOP"]}),ct=new G({currentState:p,prevOutput:"NZ",nextState:e.modifier==="Z"?r.output:y,actions:["NOP"]});this.#e.push(r.output);let pt=this.#t(new P(y,i,"*"),e.body);return this.#e.pop(),[...c,...x,N,ct,...pt]}#a(r){let e=r.inputZNZ==="*"?r.input:this.#r(),n=r.inputZNZ==="*"?[]:[this.#i(r.input,e,r.inputZNZ)];return{startState:e,fromZOrNZ:n}}#h(r,e){let n=e.level??1;if(n<1)throw new u("break level is less than 1",e.span);let o=this.#e[this.#e.length-n];if(o===void 0)throw n===1?new u("break outside while or loop",e.span):new u("break level is greater than number of nests of while or loop",e.span);return[this.#i(r.input,o,r.inputZNZ)]}};function Pr(t,r={}){return new yr(r).transpile(t)}function xe(t){let r=new Set,e=[];for(let n of t)r.has(n)?e.push(n):r.add(n);return e}function Ae(t){return`${t} argument${t===1?"":"s"}`}function Tn(){throw new Error("internal error")}function $n(t,r){let e=r.args;if(e.length!==t.args.length)throw new u(`Error at "${t.name}": this macro takes ${Ae(t.args.length)} but ${Ae(e.length)} was supplied${A(r.span?.start)}`,r.span);let n=new Map(t.args.map((o,s)=>[o.name,e[s]??Tn()]));return t.body.transform(o=>{if(o instanceof D){let s=n.get(o.name);if(s===void 0)throw new u(`Error: Unknown variable "${o.name}"${A(o.span?.start)}`,o.span);return s}else return o})}var Rn=1e5,wr=class t{#o;#e=0;main;constructor(r,e){this.main=r,this.#o=e}static make(r){let e=new Map(r.macros.map(n=>[n.name,n]));if(e.size<r.macros.length){let o=xe(r.macros.map(c=>c.name))[0],s=r.macros.slice().reverse().find(c=>c.name===o)?.span,i=s?.start;throw new u(`There is a macro with the same name: "${o}"`+A(i),s)}return new t(r,e)}expand(){return this.#n(this.main.seqExpr)}#n(r){if(Rn<this.#e)throw Error("too many macro expansion");return this.#e++,r.transform(e=>this.#s(e))}#s(r){return r instanceof B?this.#r(r):r}#r(r){let e=this.#o.get(r.name);if(e!==void 0){let n=$n(e,r);return this.#n(n)}else return r}};function ge(t){return wr.make(t).expand()}function be(t){return t.transform(Dn)}function Dn(t){return t instanceof h?vn(t):t}function vn(t){let r=[];for(let e of t.exprs)e instanceof h?r=r.concat(e.exprs):r.push(e);return new h(r)}function at(t=void 0,r,...e){t&&console.log(t+" Start",performance.now());let n=r(...e);return t&&console.log(t+" End",performance.now()),n}function In(t,{log:r,noOptimize:e}){if(e===!0)return t;let n=at(r?"optimize apgl seq":void 0,be,t);return at(r?"optimize apgl action":void 0,fe,n)}function Cu(t,r={}){let e=r.log??!1,n=at(e?"apgm parse":void 0,ae,t);try{let o=at(e?"apgm macro expaned":void 0,ge,n),s=at(e?"apgm to apgl":void 0,Wt,o),i=In(s,{log:e,noOptimize:r.noOptimize}),c=at(e?"apgl to apgsembly":void 0,Pr,i,r),p=["# State    Input    Next state    Actions","# ---------------------------------------"];return n.headers.map(y=>y.toString()).concat(p,c)}catch(o){throw o instanceof u&&o.apgmSpan?new u([o.message,...Ft(o.apgmSpan.start,t)].join(`
`),o.apgmSpan,{cause:o.cause}):o}}export{Gn as completionParser,pe as emptyArgFuncs,Fr as formatAPGsembly,Cu as integration,ue as numArgFuncs,me as strArgFuncs};
