var ue=Object.defineProperty;var pe=(t,r)=>{for(var e in r)ue(t,e,{get:r[e],enumerable:!0})};var s={};pe(s,{Parser:()=>$,all:()=>gr,choice:()=>de,eof:()=>Ar,fail:()=>me,lazy:()=>he,location:()=>Ct,match:()=>le,ok:()=>ot,text:()=>fe});var $=class Y{constructor(r){this.action=r}parse(r){let e={index:0,line:1,column:1},n=new Ae({input:r,location:e}),o=this.skip(Ar).action(n);return o.type==="ActionOK"?{type:"ParseOK",value:o.value}:{type:"ParseFail",location:o.furthest,expected:o.expected}}tryParse(r){let e=this.parse(r);if(e.type==="ParseOK")return e.value;let{expected:n,location:o}=e,{line:i,column:a}=o,u=`parse error at line ${i} column ${a}: expected ${n.join(", ")}`;throw new Error(u)}and(r){return new Y(e=>{let n=this.action(e);if(n.type==="ActionFail")return n;e=e.moveTo(n.location);let o=e.merge(n,r.action(e));if(o.type==="ActionOK"){let i=[n.value,o.value];return e.merge(o,e.ok(o.location.index,i))}return o})}skip(r){return this.and(r).map(([e])=>e)}next(r){return this.and(r).map(([,e])=>e)}or(r){return new Y(e=>{let n=this.action(e);return n.type==="ActionOK"?n:e.merge(n,r.action(e))})}chain(r){return new Y(e=>{let n=this.action(e);if(n.type==="ActionFail")return n;let o=r(n.value);return e=e.moveTo(n.location),e.merge(n,o.action(e))})}map(r){return this.chain(e=>ot(r(e)))}thru(r){return r(this)}desc(r){return new Y(e=>{let n=this.action(e);return n.type==="ActionOK"?n:{type:"ActionFail",furthest:n.furthest,expected:r}})}wrap(r,e){return r.next(this).skip(e)}trim(r){return this.wrap(r,r)}repeat(r=0,e=1/0){if(!xr(r,e))throw new Error(`repeat: bad range (${r} to ${e})`);return r===0?this.repeat(1,e).or(ot([])):new Y(n=>{let o=[],i=this.action(n);if(i.type==="ActionFail")return i;for(;i.type==="ActionOK"&&o.length<e;){if(o.push(i.value),i.location.index===n.location.index)throw new Error("infinite loop detected; don't call .repeat() with parsers that can accept zero characters");n=n.moveTo(i.location),i=n.merge(i,this.action(n))}return i.type==="ActionFail"&&o.length<r?i:n.merge(i,n.ok(n.location.index,o))})}sepBy(r,e=0,n=1/0){if(!xr(e,n))throw new Error(`sepBy: bad range (${e} to ${n})`);return e===0?this.sepBy(r,1,n).or(ot([])):n===1?this.map(o=>[o]):this.chain(o=>r.next(this).repeat(e-1,n-1).map(i=>[o,...i]))}node(r){return gr(Ct,this,Ct).map(([e,n,o])=>({type:"ParseNode",name:r,value:n,start:e,end:o}))}};function xr(t,r){return t<=r&&t>=0&&r>=0&&Number.isInteger(t)&&t!==1/0&&(Number.isInteger(r)||r===1/0)}var Ct=new $(t=>t.ok(t.location.index,t.location));function ot(t){return new $(r=>r.ok(r.location.index,t))}function me(t){return new $(r=>r.fail(r.location.index,t))}var Ar=new $(t=>t.location.index<t.input.length?t.fail(t.location.index,["<EOF>"]):t.ok(t.location.index,"<EOF>"));function fe(t){return new $(r=>{let e=r.location.index,n=e+t.length;return r.input.slice(e,n)===t?r.ok(n,t):r.fail(e,[t])})}function le(t){for(let e of t.flags)switch(e){case"i":case"s":case"m":case"u":continue;default:throw new Error("only the regexp flags 'imsu' are supported")}let r=new RegExp(t.source,t.flags+"y");return new $(e=>{let n=e.location.index;r.lastIndex=n;let o=e.input.match(r);if(o){let i=n+o[0].length,a=e.input.slice(n,i);return e.ok(i,a)}return e.fail(n,[String(t)])})}function gr(...t){return t.reduce((r,e)=>r.chain(n=>e.map(o=>[...n,o])),ot([]))}function de(...t){return t.reduce((r,e)=>r.or(e))}function he(t){let r=new $(e=>(r.action=t().action,r.action(e)));return r}function xe(t,r){return[...new Set([...t,...r])]}var Ae=class br{constructor(r){this.input=r.input,this.location=r.location}moveTo(r){return new br({input:this.input,location:r})}_internal_move(r){if(r===this.location.index)return this.location;let e=this.location.index,n=r,o=this.input.slice(e,n),{line:i,column:a}=this.location;for(let u of o)u===`
`?(i++,a=1):a++;return{index:r,line:i,column:a}}ok(r,e){return{type:"ActionOK",value:e,location:this._internal_move(r),furthest:{index:-1,line:-1,column:-1},expected:[]}}fail(r,e){return{type:"ActionFail",furthest:this._internal_move(r),expected:e}}merge(r,e){if(e.furthest.index>r.furthest.index)return e;let n=e.furthest.index===r.furthest.index?xe(r.expected,e.expected):r.expected;return e.type==="ActionOK"?{type:"ActionOK",location:e.location,value:e.value,furthest:r.furthest,expected:n}:{type:"ActionFail",furthest:r.furthest,expected:n}}};var f=class{pretty(){return""}doesReturnValue(){return!1}isSameComponent(r){return!0}};var Zt="A1",zt="B0",Ut="B1",Er="ADD";function ge(t){switch(t){case 0:return Zt;case 1:return zt;case 2:return Ut}}function be(t){switch(t){case Zt:return 0;case zt:return 1;case Ut:return 2}}var X=class t extends f{constructor(r){super(),this.op=r}pretty(){return`${Er} ${ge(this.op)}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(n===Er&&(o===Zt||o===zt||o===Ut))return new t(be(o))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(r){return r instanceof t}};var St="INC",kt="TDEC",Pt="READ",wt="SET",Ft="B2DX",Wt="B2DY",Ht="B2D",Ee="DEC",yr="SQX",Sr="SQY",Pr="SQ";function wr(t){switch(t){case St:return 0;case kt:return 1;case Pt:return 2;case wt:return 3}}function ye(t){switch(t){case 0:return St;case 1:return kt;case 2:return Pt;case 3:return wt}}function Gr(t){switch(t){case Ft:return 4;case Wt:return 5;case Ht:return 6}}function Se(t){switch(t){case 4:return Ft;case 5:return Wt;case 6:return Ht}}var ct=class t extends f{constructor(r,e){super(),this.op=r,this.axis=e}pretty(){return`${ye(this.op)} ${Se(this.axis)}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(!(n===void 0||o===void 0)){if(n===St||n===kt){if(o===Ft||o===Wt)return new t(wr(n),Gr(o))}else if((n===Pt||n===wt)&&o===Ht)return new t(wr(n),Gr(o));switch(n){case St:switch(o){case yr:return new t(0,4);case Sr:return new t(0,5);default:return}case Ee:switch(o){case yr:return new t(1,4);case Sr:return new t(1,5);default:return}case Pt:switch(o){case Pr:return new t(2,6);default:return}case wt:switch(o){case Pr:return new t(3,6);default:return}}}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(r){if(r instanceof t){let e=this.axis,n=r.axis;return e===4&&n===5?!1:!(e===5&&n===4)}return!1}};var Vt="INC",Yt="TDEC",Xt="READ",qt="SET",Nr="B";function Pe(t){switch(t){case 0:return Vt;case 1:return Yt;case 2:return Xt;case 3:return qt}}function we(t){switch(t){case Vt:return 0;case Yt:return 1;case Xt:return 2;case qt:return 3}}var D=class t extends f{constructor(r,e){super(),this.op=r,this.regNumber=e,this.registerCache=void 0}pretty(){return`${Pe(this.op)} ${Nr}${this.regNumber}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(!(n===void 0||o===void 0)&&(n===Vt||n===Yt||n===Xt||n===qt)&&o.startsWith(Nr)){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new t(we(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(r){return r instanceof t?this.regNumber===r.regNumber:!1}};var Mr="HALT_OUT",g=class t extends f{constructor(){super()}pretty(){return Mr}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==1)return;let[n]=e;if(n===Mr)return new t}doesReturnValue(){return!1}isSameComponent(r){return r instanceof t}};var Jt="0",Qt="1",Br="MUL";function Ge(t){switch(t){case Jt:return 0;case Qt:return 1}}function Ne(t){switch(t){case 0:return Jt;case 1:return Qt}}var mt=class t extends f{constructor(r){super(),this.op=r}pretty(){return`${Br} ${Ne(this.op)}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(n===Br&&(o===Jt||o===Qt))return new t(Ge(o))}doesReturnValue(){return!0}isSameComponent(r){return r instanceof t}};var Lr="NOP",S=class t extends f{constructor(){super()}pretty(){return Lr}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==1)return;let[n]=e;if(n===Lr)return new t}doesReturnValue(){return!0}isSameComponent(r){return r instanceof t}};var Tr="OUTPUT",ft=class t extends f{constructor(r){super(),this.digit=r}pretty(){return`${Tr} ${this.digit}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(n===Tr&&o!==void 0)return new t(o)}doesReturnValue(){return!1}isSameComponent(r){return r instanceof t}};var tr="A1",rr="B0",er="B1",Rr="SUB";function Me(t){switch(t){case 0:return tr;case 1:return rr;case 2:return er}}function Be(t){switch(t){case tr:return 0;case rr:return 1;case er:return 2}}var lt=class t extends f{constructor(r){super(),this.op=r}pretty(){return`${Rr} ${Me(this.op)}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(n===Rr&&(o===tr||o===rr||o===er))return new t(Be(o))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(r){return r instanceof t}};var nr="INC",or="TDEC",$r="U",Le="R";function Te(t){switch(t){case 0:return nr;case 1:return or}}function Re(t){switch(t){case nr:return 0;case or:return 1}}var I=class t extends f{constructor(r,e){super(),this.op=r,this.regNumber=e,this.registerCache=void 0}pretty(){return`${Te(this.op)} ${$r}${this.regNumber}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(!(n===void 0||o===void 0)&&(n===nr||n===or)&&(o.startsWith($r)||o.startsWith(Le))){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new t(Re(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0}}isSameComponent(r){return r instanceof t?this.regNumber===r.regNumber:!1}};var ir="INC",sr="DEC",ar="READ",cr="SET",ur="RESET";function $e(t){switch(t){case 0:return ir;case 1:return sr;case 2:return ar;case 3:return cr;case 4:return ur}}function De(t){switch(t){case ir:return 0;case sr:return 1;case ar:return 2;case cr:return 3;case ur:return 4}}var K=class t extends f{constructor(r,e){super(),this.op=r,this.regNumber=e}pretty(){return`${$e(this.op)} T${this.regNumber}`}static parse(r){let e=r.trim().split(/\s+/u);if(e.length!==2)return;let[n,o]=e;if(!(n===void 0||o===void 0)&&(n===ir||n===sr||n===ar||n===cr||n===ur)&&o.startsWith("T")){let i=o.slice(1);if(/^[0-9]+$/u.test(i))return new t(De(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!0;case 1:return!0;case 2:return!0;case 3:return!1;case 4:return!1}}isSameComponent(r){return r instanceof t?this.regNumber===r.regNumber:!1}};function J(t){let r=[D.parse,I.parse,ct.parse,S.parse,X.parse,mt.parse,lt.parse,ft.parse,g.parse,K.parse];for(let e of r){let n=e(t);if(n!==void 0)return n}}var ts=Number.parseInt,rs=Number.isNaN;var _e=s.match(/[0-9]+/).desc(["number"]).map(t=>({raw:t,value:parseInt(t,10)})),Oe=s.match(/0x[a-fA-F0-9]+/).desc(["hexadecimal number"]).map(t=>({raw:t,value:parseInt(t,16)})),Dr=Oe.or(_e).desc(["number"]);var d=class{constructor(){}},p=class extends Error{constructor(e,n,o){super(e,o);this.apgmSpan=n}};function Ir(t){return`line ${t.line} column ${t.column}`}function x(t){return t!==void 0?` at ${Ir(t)}`:""}var N=class t extends d{constructor(e,n,o){super();this.name=e;this.args=n;this.span=o}transform(e){return e(new t(this.name,this.args.map(n=>n.transform(e)),this.span))}pretty(){return`${this.name}(${this.args.map(e=>e.pretty()).join(", ")})`}};var M=class t extends d{constructor(e,n,o,i,a){super();this.modifier=e;this.cond=n;this.thenBody=o;this.elseBody=i;this.span=a}transform(e){return e(new t(this.modifier,this.cond.transform(e),this.thenBody.transform(e),this.elseBody!==void 0?this.elseBody.transform(e):void 0,this.span))}pretty(){let e=`if_${this.modifier==="Z"?"z":"nz"}`,n=this.cond.pretty(),o=this.elseBody===void 0?"":` else ${this.elseBody.pretty()}`;return`${e} (${n}) ${this.thenBody.pretty()}`+o}};var B=class t extends d{constructor(e){super();this.body=e}transform(e){return e(new t(this.body.transform(e)))}pretty(){return`loop ${this.body.pretty()}`}};var xt=class{constructor(r,e,n,o){this.name=r;this.args=e;this.body=n;this.span=o}pretty(){return`macro ${this.name}(${this.args.map(r=>r.pretty()).join(", ")}) ${this.body.pretty()}`}};var At=class{constructor(r,e,n){this.macros=r;this.headers=e;this.seqExpr=n}pretty(){return[this.macros.map(r=>r.pretty()).join(`
`),this.headers.map(r=>r.toString()).join(`
`),this.seqExpr.prettyInner()].join(`
`)}};var gt=class{constructor(r,e){this.name=r;this.content=e}toString(){let r=this.content.startsWith(" ")?"":" ";return`#${this.name}${r}${this.content}`}};var L=class extends d{constructor(e,n,o){super();this.value=e;this.span=n;this.raw=o}transform(e){return e(this)}pretty(){return this.value.toString()}};var v=class extends d{constructor(e,n){super();this.value=e;this.span=n}transform(e){return e(this)}pretty(){return'"'+this.value+'"'}};var _=class t extends d{constructor(e){super();this.exprs=e}transform(e){return e(new t(this.exprs.map(n=>n.transform(e))))}pretty(){return`{${this.prettyInner()}}`}prettyInner(){return this.exprs.map(e=>e instanceof M||e instanceof B||e instanceof T?e.pretty():e.pretty()+";").join(`
`)}};var R=class extends d{constructor(e,n){super();this.name=e;this.span=n}transform(e){return e(this)}pretty(){return this.name}};var T=class t extends d{constructor(e,n,o){super();this.modifier=e;this.cond=n;this.body=o}transform(e){return e(new t(this.modifier,this.cond.transform(e),this.body.transform(e)))}pretty(){return`while_${this.modifier==="Z"?"z":"nz"}(${this.cond.pretty()}) ${this.body.pretty()}`}};function _t(t,r){let e=r.split(/\r?\n/),n=e[t.line-2],o=e[t.line-1],i=e[t.line],a=" ".repeat(Math.max(0,t.column-1))+"^",u=n===void 0?[]:[n],c=i===void 0?[]:[i],E=" | ",w=t.line.toString(),et=" ".repeat(w.length);return[...u.map(nt=>et+E+nt),w+E+o,et+E+a,...c.map(nt=>et+E+nt)]}function Ce(t,r){let e=_t(t.location,r);return[`parse error at line ${t.location.line} column ${t.location.column}:`,`  expected ${t.expected.join(", ")}`,"",...e].join(`
`)}function vr(t,r){let e=t.parse(r);if(e.type==="ParseOK")return e.value;throw new p(Ce(e,r),{start:e.location,end:e.location})}function O(t,r){let e=r.length;return{start:t,end:{index:t.index+e-1,line:t.line,column:t.column+e}}}var _r=s.location.chain(t=>s.text('"').next(s.match(/[^"]*/)).skip(s.text('"')).desc(["string"]).map(r=>({value:r,span:O(t,`"${r}"`)})));var Ze=s.match(/\/\*(\*(?!\/)|[^*])*\*\//s).desc([]),l=s.match(/\s*/).desc(["space"]).sepBy(Ze).map(()=>{}),ze=s.match(/\s+/).desc(["space"]),Ue=/[a-zA-Z_][a-zA-Z_0-9]*/u,Zr=s.match(Ue).desc(["identifier"]),ke=Zr.wrap(l,l),Fe=l.chain(()=>s.location.chain(t=>Zr.skip(l).map(r=>[r,O(t,r)]))),We=/[a-zA-Z_][a-zA-Z_0-9]*!/u,zr=s.match(We).wrap(l,l).desc(["macro name"]);function G(t){return s.text(t).wrap(l,l)}function Or(t){return s.location.chain(e=>s.text(t).map(n=>[n,O(e,t)])).wrap(l,l)}var He=G(",").desc(["`,`"]),Ur=G("(").desc(["`(`"]),kr=G(")").desc(["`)`"]),Ve=G(";").desc(["`;`"]),Ye=G("{").desc(["`{`"]),Xe=G("}").desc(["`}`"]),Fr=Fe.map(([t,r])=>new R(t,r));function Wr(t){return s.lazy(()=>t()).sepBy(He).wrap(Ur,kr)}function qe(){return l.next(s.location).chain(t=>s.choice(zr,ke).chain(r=>Wr(()=>C()).map(e=>new N(r,e,O(t,r)))))}var je=s.location.chain(t=>Dr.map(r=>new L(r.value,O(t,r.raw),r.raw))).wrap(l,l),Ke=_r.wrap(l,l).map(t=>new v(t.value,t.span)),Hr=s.lazy(()=>an()).repeat(),Je=Hr.wrap(Ye,Xe).map(t=>new _(t)),Qe=s.choice(G("while_z"),G("while_nz")).map(t=>t==="while_z"?"Z":"NZ"),Vr=s.lazy(()=>C()).wrap(Ur,kr),Yr=Qe.chain(t=>Vr.chain(r=>C().map(e=>new T(t,r,e)))),Xr=G("loop").next(s.lazy(()=>C())).map(t=>new B(t)),tn=s.choice(Or("if_z"),Or("if_nz")).map(t=>t[0]==="if_z"?["Z",t[1]]:["NZ",t[1]]),qr=tn.chain(([t,r])=>Vr.chain(e=>s.lazy(()=>C()).chain(n=>s.choice(G("else").next(s.lazy(()=>C())),s.ok(void 0)).map(o=>new M(t,e,n,o,r))))),Cr="macro",rn=l.chain(t=>s.location.chain(r=>s.text(Cr).next(ze).map(e=>O(r,Cr))));function pr(){return rn.and(zr).chain(([t,r])=>Wr(()=>Fr).map(e=>({span:t,name:r,args:e})))}function en(){return pr().chain(({span:t,name:r,args:e})=>s.lazy(()=>C()).map(n=>new xt(r,e,n,t)))}var nn=s.match(/.*/),on=s.text("#").next(s.match(/REGISTERS|COMPONENTS/)).desc(["#REGISTERS","#COMPONENTS"]).chain(t=>nn.map(r=>new gt(t,r))),sn=on.wrap(l,l).repeat();function C(){return s.choice(Xr,Yr,qr,s.lazy(()=>qe()),Je,Fr,je,Ke)}function an(){return s.choice(Xr,Yr,qr,C().skip(Ve))}function cn(){return en().repeat().chain(t=>sn.chain(r=>Hr.wrap(l,l).map(e=>new At(t,r,new _(e)))))}function jr(t){return vr(cn(),t)}var A=class{constructor(){}};var b=class extends A{constructor(e){super();this.actions=e}transform(e){return e(this)}};var h=class t extends A{constructor(e){super();this.exprs=e}transform(e){return e(new t(this.exprs.map(n=>n.transform(e))))}};function F(t){return t instanceof h&&t.exprs.every(r=>F(r))}function tt(t){if(t instanceof b)return t;if(t instanceof h&&t.exprs.length===1){let r=t.exprs[0];return tt(r)}}var Z=class t extends A{constructor(e,n,o){super();this.cond=e;this.thenBody=n;this.elseBody=o}transform(e){return e(new t(this.cond.transform(e),this.thenBody.transform(e),this.elseBody.transform(e)))}};var W=class t extends A{constructor(e){super();this.body=e}kind="loop";transform(e){return e(new t(this.body.transform(e)))}};var H=class t extends A{constructor(e,n,o){super();this.modifier=e;this.cond=n;this.body=o}transform(e){return e(new t(this.modifier,this.cond.transform(e),this.body.transform(e)))}};var z=class extends A{constructor(e,n){super();this.level=e;this.span=n}kind="break";transform(e){return e(this)}};var m=class t{static incU(r){return t.nonReturn(`INC U${r}`)}static incUMulti(...r){return new b([...r.map(e=>`INC U${e}`),"NOP"])}static tdecU(r){return t.single(`TDEC U${r}`)}static addA1(){return t.nonReturn("ADD A1")}static addB0(){return t.single("ADD B0")}static addB1(){return t.single("ADD B1")}static incB2DX(){return t.nonReturn("INC B2DX")}static tdecB2DX(){return t.single("TDEC B2DX")}static incB2DY(){return t.nonReturn("INC B2DY")}static tdecB2DY(){return t.single("TDEC B2DY")}static readB2D(){return t.single("READ B2D")}static setB2D(){return t.nonReturn("SET B2D")}static incB(r){return t.nonReturn(`INC B${r}`)}static tdecB(r){return t.single(`TDEC B${r}`)}static readB(r){return t.single(`READ B${r}`)}static setB(r){return t.nonReturn(`SET B${r}`)}static haltOUT(){return t.single("HALT_OUT")}static mul0(){return t.single("MUL 0")}static mul1(){return t.single("MUL 1")}static nop(){return t.single("NOP")}static output(r){return t.nonReturn(`OUTPUT ${r}`)}static subA1(){return t.nonReturn("SUB A1")}static subB0(){return t.single("SUB B0")}static subB1(){return t.single("SUB B1")}static nonReturn(r){return new b([r,"NOP"])}static single(r){return new b([r])}};function un(t,r){if(t.args.length!==0)throw new p(`"${t.name}" expects empty argments${x(t.span?.start)}`,t.span);return r}function Kr(t,r){if(t.args.length!==1)throw new p(`number of arguments is not 1: "${t.name}"${x(t.span?.start)}`,t.span);let e=t.args[0];if(!(e instanceof L))throw new p(`argument is not a number: "${t.name}"${x(t.span?.start)}`,t.span);return r(e.value)}function pn(t,r){if(t.args.length!==1)throw new p(`number of arguments is not 1: "${t.name}"${x(t.span?.start)}`,t.span);let e=t.args[0];if(!(e instanceof v))throw new p(`argument is not a string: "${t.name}"${x(t.span?.start)}`,t.span);return r(e.value)}var Jr=new Map([["nop",m.nop()],["inc_b2dx",m.incB2DX()],["inc_b2dy",m.incB2DY()],["tdec_b2dx",m.tdecB2DX()],["tdec_b2dy",m.tdecB2DY()],["read_b2d",m.readB2D()],["set_b2d",m.setB2D()],["add_a1",m.addA1()],["add_b0",m.addB0()],["add_b1",m.addB1()],["sub_a1",m.subA1()],["sub_b0",m.subB0()],["sub_b1",m.subB1()],["mul_0",m.mul0()],["mul_1",m.mul1()],["halt_out",m.haltOUT()]]),Qr=new Map([["inc_u",m.incU],["tdec_u",m.tdecU],["inc_b",m.incB],["tdec_b",m.tdecB],["read_b",m.readB],["set_b",m.setB]]),te=new Map([["output",m.output]]);function mn(t){let r=Jr.get(t.name);if(r!==void 0)return un(t,r);let e=Qr.get(t.name);if(e!==void 0)return Kr(t,e);let n=te.get(t.name);if(n!==void 0)return pn(t,n);switch(t.name){case"break":return t.args.length===0?new z(void 0,t.span):Kr(t,o=>new z(o,t.span));case"repeat":{if(t.args.length!==2)throw new p(`"repeat" takes two arguments${x(t.span?.start)}`,t.span);let o=t.args[0];if(!(o instanceof L))throw new p(`first argument of "repeat" must be a number${x(t.span?.start)}`,t.span);let i=t.args[1];if(i===void 0)throw new Error("internal error");let a=Ot(i);return new h(Array(o.value).fill(0).map(()=>a))}}throw new p(`Unknown ${t.name.endsWith("!")?"macro":"function"}: "${t.name}"${x(t.span?.start)}`,t.span)}function Ot(t){let r=Ot;if(t instanceof N)return mn(t);if(t instanceof M)return t.modifier==="Z"?new Z(r(t.cond),r(t.thenBody),t.elseBody===void 0?new h([]):r(t.elseBody)):new Z(r(t.cond),t.elseBody===void 0?new h([]):r(t.elseBody),r(t.thenBody));if(t instanceof B)return new W(r(t.body));if(t instanceof L)throw new p(`number is not allowed: ${t.raw??t.value}${x(t.span?.start)}`,t.span);if(t instanceof _)return new h(t.exprs.map(e=>r(e)));if(t instanceof v)throw new p(`string is not allowed: ${t.pretty()}${x(t.span?.start)}`,t.span);if(t instanceof T)return new H(t.modifier,r(t.cond),r(t.body));throw t instanceof R?new p(`macro variable is not allowed: variable "${t.name}"${x(t.span?.start)}`,t.span):Error("internal error")}function fn(t){let r="",e=!1,n=0;for(;n<t.length;){let o=t[n],i=t[n+1];o==="/"&&i==="*"?(n+=2,e=!0):o==="*"&&i==="/"?(e=!1,n+=2):(e||(r+=o),n++)}return r}function ln(t){let r=[],e=/(macro\s+([a-zA-Z_][a-zA-Z_0-9]*?!)\s*\(.*?\))/gs,n=fn(t).matchAll(e);for(let o of n){let i=pr().parse(o[0]);i.type==="ParseOK"&&r.push({name:i.value.name,args:i.value.args.map(a=>a.name)})}return r}function re(t){return t.transform(dn)}function dn(t){return t instanceof h?xn(t):t}function ee(t,r){let e=ne(mr(t),mr(r));return e===void 0?void 0:oe(e)}var hn=new S;function ne(t,r){if(t.length===0)return r.slice();if(r.length===0)return t.slice();if(t.some(c=>c instanceof g)||r.some(c=>c instanceof g))return;let e=t.filter(c=>!(c instanceof S)),n=r.filter(c=>!(c instanceof S)),o=e.every(c=>!c.doesReturnValue()),i=n.every(c=>!c.doesReturnValue());if(!o&&!i||!e.every(c=>n.every(E=>!c.isSameComponent(E))))return;let u=e.concat(n);return o&&i&&u.push(hn),u}function mr(t){return t.actions.flatMap(r=>{let e=J(r);return e!==void 0?[e]:[]})}function oe(t){return new b(t.map(r=>r.pretty()))}function xn(t){let r=[],e=[],n=()=>{e.length!==0&&(r.push(oe(e)),e=[])};for(let o of t.exprs)if(o instanceof b){let i=mr(o),a=ne(e,i);a===void 0?(n(),e=i):e=a}else n(),r.push(o);return n(),new h(r)}var y=class{constructor(r,e,n){this.input=r;this.output=e;this.inputZNZ=n}};function An(t){let r=t.prevOutput,e=r;return(r==="*"||r==="Z")&&(e=" "+r),`${t.currentState}; ${e}; ${t.nextState}; ${t.actions.join(", ")}`}var P=class{constructor(r){this.inner=r;if(this.inner.actions.length===0)throw Error("actions must be nonempty")}},fr=class{#o=0;#e=[];#n;#i;constructor(r={}){this.#n=r.prefix??"STATE_",this.#i=!(r.noOptimize??!1)}#r(){return this.#o++,`${this.#n}${this.#o}`}#s(r,e,n="*"){return new P({currentState:r,prevOutput:n,nextState:e,actions:["NOP"]})}transpile(r){let e="INITIAL",n=this.#r()+"_INITIAL",o=this.#s(e,n,"ZZ"),i=this.#n+"END",a=this.#t(new y(n,i,"*"),r),u=new P({currentState:i,prevOutput:"*",nextState:i,actions:["HALT_OUT"]});return[o,...a,u].map(c=>An(c.inner))}#t(r,e){if(e instanceof b)return[this.#c(r,e)];if(e instanceof h)return this.#p(r,e);if(e instanceof Z)return this.#m(r,e);if(e instanceof W)return this.#f(r,e);if(e instanceof H)return this.#d(r,e);if(e instanceof z)return this.#h(r,e);throw Error("unknown expr")}#c(r,e){return new P({currentState:r.input,prevOutput:r.inputZNZ,nextState:r.output,actions:e.actions})}#p(r,e){if(F(e))return[this.#s(r.input,r.output,r.inputZNZ)];if(e.exprs.length===1){let a=e.exprs[0];if(a===void 0)throw new Error("internal error");return this.#t(r,a)}let n=[],o=r.input,i=e.exprs.length-1;for(let[a,u]of e.exprs.entries())if(a!==i){let c=this.#r();n=n.concat(this.#t(new y(o,c,a===0?r.inputZNZ:"*"),u)),o=c}else n=n.concat(this.#t(new y(o,r.output,"*"),u));return n}#m(r,e){if(this.#i&&F(e.thenBody)&&F(e.elseBody))return this.#t(r,e.cond);let n=this.#r(),o=this.#t(new y(r.input,n,r.inputZNZ),e.cond),[i,...a]=this.#t(new y(n,r.output,"Z"),e.thenBody),[u,...c]=this.#t(new y(n,r.output,"NZ"),e.elseBody);return[...o,i,u,...a,...c]}#f(r,e){let{startState:n,fromZOrNZ:o}=this.#a(r);this.#e.push(r.output);let i=this.#t(new y(n,n,"*"),e.body);return this.#e.pop(),[...o,...i]}#u(r,e,n,o){let{startState:i,fromZOrNZ:a}=this.#a(r),u=this.#r(),c=this.#c(new y(i,u,"*"),e),E=new P({currentState:u,prevOutput:"Z",nextState:o==="Z"?u:r.output,actions:o==="Z"?n.actions:["NOP"]}),w=new P({currentState:u,prevOutput:"NZ",nextState:o==="Z"?r.output:u,actions:o==="Z"?["NOP"]:n.actions});return[...a,c,E,w]}#l(r,e,n){let{startState:o,fromZOrNZ:i}=this.#a(r),a=this.#r(),u=this.#t(new y(o,a,"*"),e),c=new P({currentState:a,prevOutput:"Z",nextState:n==="Z"?o:r.output,actions:["NOP"]}),E=new P({currentState:a,prevOutput:"NZ",nextState:n==="Z"?r.output:o,actions:["NOP"]});return[...i,...u,c,E]}#d(r,e){let n=this.#i;if(n&&F(e.body)){let V=tt(e.cond);return V!==void 0?this.#u(r,V,V,e.modifier):this.#l(r,e.cond,e.modifier)}let o=tt(e.body),i=tt(e.cond);if(n&&i!==void 0&&o!==void 0){let V=ee(o,i);if(V!==void 0)return this.#u(r,i,V,e.modifier)}let{startState:a,fromZOrNZ:u}=this.#a(r),c=this.#r(),E=this.#t(new y(a,c,"*"),e.cond),w=this.#r()+"_WHILE_BODY",et=new P({currentState:c,prevOutput:"Z",nextState:e.modifier==="Z"?w:r.output,actions:["NOP"]}),hr=new P({currentState:c,prevOutput:"NZ",nextState:e.modifier==="Z"?r.output:w,actions:["NOP"]});this.#e.push(r.output);let nt=this.#t(new y(w,a,"*"),e.body);return this.#e.pop(),[...u,...E,et,hr,...nt]}#a(r){let e=r.inputZNZ==="*"?r.input:this.#r(),n=r.inputZNZ==="*"?[]:[this.#s(r.input,e,r.inputZNZ)];return{startState:e,fromZOrNZ:n}}#h(r,e){let n=e.level??1;if(n<1)throw new p("break level is less than 1",e.span);let o=this.#e[this.#e.length-n];if(o===void 0)throw n===1?new p("break outside while or loop",e.span):new p("break level is greater than number of nests of while or loop",e.span);return[this.#s(r.input,o,r.inputZNZ)]}};function lr(t,r={}){return new fr(r).transpile(t)}function ie(t){let r=new Set,e=[];for(let n of t)r.has(n)?e.push(n):r.add(n);return e}function se(t){return`${t} argument${t===1?"":"s"}`}function gn(){throw new Error("internal error")}function bn(t,r){let e=r.args;if(e.length!==t.args.length)throw new p(`Error at "${t.name}": this macro takes ${se(t.args.length)} but ${se(e.length)} was supplied`+ +`${x(r.span?.start)}`,r.span);let n=new Map(t.args.map((o,i)=>[o.name,e[i]??gn()]));return t.body.transform(o=>{if(o instanceof R){let i=n.get(o.name);if(i===void 0)throw new p(`scope error: Unknown variable "${o.name}"${x(o.span?.start)}`,o.span);return i}else return o})}var En=1e5,dr=class t{#o;#e=0;main;constructor(r,e){this.main=r,this.#o=e}static make(r){let e=new Map(r.macros.map(n=>[n.name,n]));if(e.size<r.macros.length){let o=ie(r.macros.map(u=>u.name))[0],i=r.macros.slice().reverse().find(u=>u.name===o)?.span,a=i?.start;throw new p(`There is a macro with the same name: "${o}"`+x(a),i)}return new t(r,e)}expand(){return this.#n(this.main.seqExpr)}#n(r){if(En<this.#e)throw Error("too many macro expansion");return this.#e++,r.transform(e=>this.#i(e))}#i(r){return r instanceof N?this.#r(r):r}#r(r){let e=this.#o.get(r.name);if(e!==void 0){let n=bn(e,r);return this.#n(n)}else return r}};function ae(t){return dr.make(t).expand()}function ce(t){return t.transform(yn)}function yn(t){return t instanceof h?Sn(t):t}function Sn(t){let r=[];for(let e of t.exprs)e instanceof h?r=r.concat(e.exprs):r.push(e);return new h(r)}function rt(t=void 0,r,...e){t&&console.log(t+" Start",performance.now());let n=r(...e);return t&&console.log(t+" End",performance.now()),n}function Pn(t,{log:r,noOptimize:e}){if(e===!0)return t;let n=rt(r?"optimize apgl seq":void 0,ce,t);return rt(r?"optimize apgl action":void 0,re,n)}function Np(t,r={}){let e=r.log??!1,n=rt(e?"apgm parse":void 0,jr,t);try{let o=rt(e?"apgm macro expaned":void 0,ae,n),i=rt(e?"apgm to apgl":void 0,Ot,o),a=Pn(i,{log:e,noOptimize:r.noOptimize}),u=rt(e?"apgl to apgsembly":void 0,lr,a,r),c=["# State    Input    Next state    Actions","# ---------------------------------------"];return n.headers.map(w=>w.toString()).concat(c,u)}catch(o){throw o instanceof p&&o.apgmSpan?new p([o.message,..._t(o.apgmSpan.start,t)].join(`
`),o.apgmSpan,{cause:o.cause}):o}}export{ln as completionParser,Jr as emptyArgFuncs,Np as integration,Qr as numArgFuncs,te as strArgFuncs};
