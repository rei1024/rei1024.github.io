var p=(e,t)=>{let r=document.querySelector(e);if(r==null)throw Error(`can't found a element for "${e}"`);if(r instanceof t)return r;throw Error(`"${e}" is not a ${t.name}`)};function d(e,t=void 0){let r=document.createElement(e);if(typeof t=="string")r.textContent=t;else if(t!=null&&typeof t=="object"&&(t.text&&(r.textContent=t.text),t.classes&&r.classList.add(...t.classes),t.fn&&(t.fn(r),t.fn=void 0),t.children&&r.append(...t.children),t.style))for(let[n,s]of Object.entries(t.style))n in r.style?r.style[n]=s:r.style.setProperty(n,s);return r}var Ht=class{#e=0;#n=-1;#t=!1;#i=0;#s=0;constructor(t,{frequency:r,signal:n}){this.#i=r;let s=requestAnimationFrame,i=o=>{if(this.#t&&this.#n!==-1){let a=o-this.#n,u=this.#e,l=u+a/1e3*this.#i,f=Math.floor(l)-Math.floor(u);this.#e=l,t(f)}this.#n=o,this.#s=s(i)};this.#s=s(i),n?.addEventListener("abort",()=>{this.abort()})}abort(){this.#s!==0&&cancelAnimationFrame(this.#s)}get frequency(){return this.#i}set frequency(t){this.#i=t}get disabled(){return!this.#t}set disabled(t){this.#t=!t}reset(){this.#e=0}};var $e=e=>e instanceof Error?e.message:"Unknown error is occurred.";function*ur(e,t){if(!Number.isInteger(t))throw RangeError("size is not an integer");let r=[];for(let n of e)r.push(n),t<=r.length&&(yield r,r=[]);r.length!==0&&(yield r)}var lr=()=>{let e=document.createElement("span");return e.classList.add("spinner-border","spinner-border-sm"),e.setAttribute("role","status"),e.setAttribute("aria-hidden","true"),e};var h=class{pretty(){return""}doesReturnValue(){return!1}isSameComponent(t){return!0}};var Ft="INC",we="TDEC",Gt="READ",Vt="SET",_e="B2DX",Te="B2DY",Ne="B2D",wn="DEC",pr="SQX",dr="SQY",fr="SQ",mr=e=>{switch(e){case Ft:return 0;case we:return 1;case Gt:return 2;case Vt:return 3}},_n=e=>{switch(e){case 0:return Ft;case 1:return we;case 2:return Gt;case 3:return Vt}},hr=e=>{switch(e){case _e:return 4;case Te:return 5;case Ne:return 6}},Tn=e=>{switch(e){case 4:return _e;case 5:return Te;case 6:return Ne}},ot=class e extends h{constructor(t,r){super(),this.op=t,this.axis=r}pretty(){return`${_n(this.op)} ${Tn(this.axis)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)){if(n===Ft||n===we){if(s===_e||s===Te)return new e(mr(n),hr(s))}else if((n===Gt||n===Vt)&&s===Ne)return new e(mr(n),hr(s));switch(n){case Ft:switch(s){case pr:return new e(0,4);case dr:return new e(0,5);default:return}case wn:switch(s){case pr:return new e(1,4);case dr:return new e(1,5);default:return}case Gt:switch(s){case fr:return new e(2,6);default:return}case Vt:switch(s){case fr:return new e(3,6);default:return}}}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){if(t instanceof e){let r=this.axis,n=t.axis;return r===4&&n===5?!1:!(r===5&&n===4)}return!1}};var c=()=>{throw Error("internal error")};var Be=(e,t)=>Array(e).fill(0).map((r,n)=>t(n)),Pt=class{constructor(){this.x=0,this.y=0,this.maxX=0,this.maxY=0,this.array=Be(1,()=>Be(1,()=>0))}getArray(){return this.array}getMaxX(){return this.maxX}getMaxY(){return this.maxY}action(t){switch(t.op){case 0:{switch(t.axis){case 4:return this.incB2DX();case 5:return this.incB2DY();case 6:c()}break}case 1:{switch(t.axis){case 4:return this.tdecB2DX();case 5:return this.tdecB2DY();case 6:c()}break}case 2:{switch(t.axis){case 6:return this.read();default:c()}break}case 3:{switch(t.axis){case 6:return this.set();default:c()}break}default:c()}}incB2DX(){if(this.x++,this.maxX<this.x){for(let t of this.array)t.push(0);this.maxX=this.x}}incB2DY(){this.y++,this.maxY<this.y&&(this.array.push(Be(this.maxX+1,()=>0)),this.maxY=this.y)}tdecB2DX(){return this.x===0?0:(this.x--,1)}tdecB2DY(){return this.y===0?0:(this.y--,1)}read(){let t=this.array[this.y];t===void 0&&c();let r=t[this.x];return r===void 0&&c(),t[this.x]=0,r}set(){let t=this.array[this.y]??c();if(t[this.x]===1)throw Error(`SET B2D: Tried to set when it was already 1. x = ${this.x}, y = ${this.y}`);t[this.x]=1}};var gr=(e,t,r,n)=>{let s=e.canvas.width,i=e.canvas.height;s!==i&&(e.canvas.height=s),e.reset?e.reset():(e.clearRect(0,0,s,s),e.resetTransform(),e.beginPath());let o=t.getMaxX(),a=t.getMaxY(),u=Math.max(o,a)+1,l=s/u;n&&(e.scale(1,-1),e.translate(0,-s));let f=t.getArray();e.fillStyle="#212529";for(let T=0;T<=a;T++){let m=f[T]??c(),y=T*l;for(let $=0;$<=o;$++)m[$]===1&&e.rect($*l,y,l,l)}e.fill(),r||(e.strokeStyle="#03A9F4",e.lineWidth=4,e.strokeRect(t.x*l,t.y*l,l,l))};var Ie="INC",Re="TDEC",xr="U",Nn="R",Bn=e=>{switch(e){case 0:return Ie;case 1:return Re}},In=e=>{switch(e){case Ie:return 0;case Re:return 1}},S=class e extends h{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${Bn(this.op)} ${xr}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===Ie||n===Re)&&(s.startsWith(xr)||s.startsWith(Nn))){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new e(In(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var Yt=class{constructor(){this.value=0}action(t){switch(t.op){case 1:return this.value===0?0:(this.value--,1);case 0:this.value++}}actionN(t,r){switch(t.op){case 1:{this.value-=r;break}case 0:{this.value+=r;break}}}getValue(){return this.value}setValue(t){this.value=t}inc(){this.action(new S(0,0))}tdec(){let t=this.action(new S(1,0));return t===void 0&&c(),t}setByRegistersInit(t,r){(typeof r!="number"||r<0||!Number.isInteger(r))&&Y(t,r),this.setValue(r)}},Y=(e,t)=>{let r=`"${e}": ${JSON.stringify(t)}`;throw Error(`Invalid #REGISTERS ${r}`)};var Rn=e=>{if(window.innerWidth<768)return e===9?e:8;let r=12;return r+1<=e&&e<=r+2?e:r},vn=e=>d("th",`U${e}`),Dn=(e,t)=>d("td",{text:t.getValue().toString(),fn:r=>{r.dataset.test=`U${e}`}}),Cn=e=>{let t=[],r=[],n=Rn(e.size);for(let i of ur(e,n)){let o=d("tr"),a=d("tr");for(let[u,l]of i){o.append(vn(u));let f=Dn(u,l);t.push(f),a.append(f)}r.push({header:o,data:a})}let s=d("table");for(let i of r)s.append(i.header,i.data);return s.classList.add("table"),s.style.tableLayout="fixed",s.style.marginBottom="0",{table:s,cells:t}},Wt=class{constructor(t){this.root=t,this.cells=[]}initialize(t){let{table:r,cells:n}=Cn(t);this.root.replaceChildren(r),this.cells=n}clear(){this.cells=[],this.root.innerHTML=""}render(t){let r=0,n=this.cells;for(let s of t.values()){let i=n[r]??c();i.textContent=s.getValue().toString(),r++}}};var ve="INC",De="TDEC",Ce="READ",Ae="SET",br="B",An=e=>{switch(e){case 0:return ve;case 1:return De;case 2:return Ce;case 3:return Ae}},Ln=e=>{switch(e){case ve:return 0;case De:return 1;case Ce:return 2;case Ae:return 3}},x=class e extends h{constructor(t,r){super(),this.op=t,this.regNumber=r,this.registerCache=void 0}pretty(){return`${An(this.op)} ${br}${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===ve||n===De||n===Ce||n===Ae)&&s.startsWith(br)){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new e(Ln(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0;case 3:return!1}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var yr=e=>[...e].map(t=>{if(t==="0")return 0;if(t==="1")return 1;throw Error(`Invalid #REGISTERS: "${e}"`)}),kn=typeof BigInt<"u",qt=e=>{let t="";for(let r=e.length-1;r>=0;r--)t+=e[r]===0?"0":"1";return t},Le=e=>{let t="",r=e.length;for(let n=0;n<r;n++)t+=e[n]===0?"0":"1";return t},Zt=class{constructor(){this.pointer=0,this.bits=[0]}action(t){switch(t.op){case 1:return this.pointer===0?0:(this.pointer--,1);case 0:{this.pointer++;let r=this.bits;this.pointer===r.length&&r.push(0);break}case 2:{let r=this.pointer,n=this.bits;if(r<n.length){let s=n[r]??c();return n[r]=0,s}else return 0}case 3:{let r=this.bits,n=this.pointer;if(n>=r.length&&this.extend(),r[n]===1)throw Error(`The bit of the binary register B${t.regNumber} is already 1`);r[n]=1;break}default:{let r=t.op}}}actionN(t,r){switch(t.op){case 0:{this.pointer+=r,this.extend();break}case 1:{this.pointer-=r;break}default:throw Error("todo")}}getBits(){return this.bits}setBits(t){this.bits=t}inc(){let t=this.action(new x(0,0));return t!==void 0&&c(),t}tdec(){let t=this.action(new x(1,0));return t===void 0&&c(),t}read(){let t=this.action(new x(2,0));return t===void 0&&c(),t}set(){let t=this.action(new x(3,0));return t!==void 0&&c(),t}extend(){let t=this.pointer,r=this.bits,n=r.length;if(t>=n)if(t===n)r.push(0);else{let s=Array(t-n+1).fill(0).map(()=>0);this.bits=this.bits.concat(s)}}toNumberString(t=10){return(kn?BigInt:Number)("0b"+qt(this.bits)).toString(t)}toObject(){this.extend();let t=this.bits,r=this.pointer;return{prefix:t.slice(0,r),head:t[r]??c(),suffix:t.slice(r+1)}}setByRegistersInit(t,r){if(typeof r=="number")this.setBits(yr(r.toString(2)).reverse()),this.extend();else if(!Array.isArray(r)||r.length!==2)Y(t,r);else{let[n,s]=r;if(typeof n!="number"||typeof s!="string"||n<0||!Number.isInteger(n))Y(t,r);else{let i=yr(s);this.pointer=n,this.setBits(i),this.extend()}}}};var Mn=()=>{let e=d("span",{classes:["decimal"]}),t=d("span",{classes:["hex"]}),r=d("span",{classes:["max_pointer"]}),n=d("span",{classes:["pointer"]});return{metaData:d("code",{classes:["binary_info","word-break-all"],children:[e,t,r,n]}),$decimal:e,$hex:t,$maxPointer:r,$pointer:n}},Un=()=>{let e=d("span",{classes:["prefix"]}),t=d("span",{classes:["binary-head"]}),r=d("span",{classes:["suffix"]});return{binaryBits:d("code",{classes:["word-break-all"],children:[e,t,r]}),$prefix:e,$head:t,$suffix:r}},jt=class{constructor(t){this.root=t,this.cells=[]}initialize(t){this.clear();let r=[],n=d("table");for(let s of t.keys()){let i=d("td");i.dataset.test=`B${s}`;let{metaData:o,$decimal:a,$hex:u,$maxPointer:l,$pointer:f}=Mn();i.append(o,d("br"));let{binaryBits:T,$prefix:m,$head:y,$suffix:$}=Un();i.append(T);let I=d("tr",{children:[d("th",`B${s}`),i]});n.append(I),r.push({$decimal:a,$hex:u,$maxPointer:l,$pointer:f,$prefix:m,$head:y,$suffix:$})}this.root.append(n),this.cells=r}clear(){this.cells=[],this.root.innerHTML=""}render(t,r,n,s,i){let o=0,a=this.cells;for(let u of t.values()){let{$prefix:l,$head:f,$suffix:T,$decimal:m,$hex:y,$maxPointer:$,$pointer:I}=a[o]??c();if(r)l.innerHTML="",f.innerHTML="",T.innerHTML="";else{let bt=u.toObject();l.textContent=n?qt(bt.suffix):Le(bt.prefix),f.textContent=bt.head.toString(),T.textContent=n?qt(bt.prefix):Le(bt.suffix)}s?m.textContent="value = "+u.toNumberString(10)+", ":m.innerHTML="",i?y.textContent="hex = "+u.toNumberString(16)+", ":y.innerHTML="",$.textContent="max_pointer = "+(u.getBits().length-1)+", ",I.textContent="pointer = "+u.pointer.toString(),o++}}};var R=e=>e.toLocaleString();var Sr="stats_current_state",zn=(e,{z:t,nz:r})=>{let n=d("td",{fn:l=>{l.colSpan=2},children:[d("code",e)]}),s="num",i=d("td",{text:R(t+r),classes:[s]}),o=d("td",{text:R(t),classes:[s]}),a=d("td",{text:R(r),classes:[s]});return{$tr:d("tr",{children:[n,i,o,a]}),$sum:i,$z:o,$nz:a}},Xt=class{#e;constructor(t,r){this.root=t,this.#e=r,this.cells=[]}initialize(t,r){this.#e.textContent=R(r.length),this.cells=[],this.root.innerHTML="";for(let[n,s]of t.entries()){let i=r[n]??"",{$tr:o,$sum:a,$z:u,$nz:l}=zn(i,s);this.root.append(o),this.cells.push({$sum:a,$z:u,$nz:l,$tr:o})}}clear(){this.#e.innerHTML="",this.cells=[],this.root.innerHTML=""}render(t,r){let n=t,s=this.cells,i=s.length;for(let o=0;o<i;o++){let a=s[o]??c();r===o?a.$tr.classList.add(Sr):a.$tr.classList.remove(Sr);let{z:u,nz:l}=n[o]??c();a.$sum.textContent=R(u+l),a.$z.textContent=R(u),a.$nz.textContent=R(l)}}};function Er(e,t){if(e.innerHTML="",t===void 0)return;let r=d("option","None");r.value="-1",r.selected=!0,e.append(r);for(let[n,s]of t.getStateMap()){let i=d("option",n);i.value=s.toString(),e.append(i)}}function $r(e){switch(e.value){case"*":return-1;case"Z":return 0;default:return 1}}var On="Start",Hn="Stop",wr="btn-primary",_r="btn-danger",Tr=e=>`<svg width="16" height="16" viewBox="0 0 16 16">${e}</svg>`,Fn=()=>{let e=d("div");return e.innerHTML=Tr('<path stroke="currentColor" stroke-width="1" d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/>')+On,e},Gn=Fn(),Vn=()=>{let e=d("div");return e.innerHTML=Tr('<path stroke="currentColor" stroke-width="1" d="M3.5 5A1.5 1.5 0 0 1 5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5zM5 4.5a.5.5 0 0 0-.5.5v6a.5.5 0 0 0 .5.5h6a.5.5 0 0 0 .5-.5V5a.5.5 0 0 0-.5-.5H5z"/>')+Hn,e},Pn=Vn();function yt(e){e.disabled=!1,e.replaceChildren(Gn),e.classList.add(wr),e.classList.remove(_r)}function Nr(e){e.disabled=!1,e.replaceChildren(Pn),e.classList.remove(wr),e.classList.add(_r)}function Br(e,t,r){if(e.replaceChildren(),t==="RuntimeError"||t==="ParseError"){let n=r.split(`
`);for(let s of n)e.append(d("span","- "+s),d("br"));e.classList.remove("d-none")}else e.classList.add("d-none")}var St=40,Kt=window.innerWidth;Kt>=1200?St=120:Kt>=992?St=100:Kt>=768?St=70:Kt>=576&&(St=50);var Ir=(e,t)=>{if(t=t??"",e.value===t)return;e.value=t;let r=t.length,s=Math.min(6,Math.max(1,Math.ceil(r/St)));e.rows=s};var Yn=()=>{let e=[];for(let r=0;r<=6;r++)for(let n=1;n<=9;n++)e.push(n*10**r);return e.push(10*10**6,15*10**6,20*10**6),e};function Rr(e,t){let r=Yn();e.min="0",e.max=(r.length-1).toString(),e.addEventListener("input",()=>{let n=parseInt(e.value,10),s=r[n]??c();e.ariaValueText=`(${s.toString()}Hz)`,t.setFrequency(s)})}var vr=(e,t)=>{e.setCustomValidity(t),e.reportValidity(),e.classList.add("is-invalid")},Dr=e=>{e.setCustomValidity(""),e.reportValidity(),e.classList.remove("is-invalid")};function Cr(e,t){e.addEventListener("input",()=>{let r=e.files?.item(0);r?.text().then(t)})}var Qt=window.requestIdleCallback??(e=>{setTimeout(()=>{e({didTimeout:!1,timeRemaining(){return 0}})},0)});function Et(e,t){try{localStorage.setItem(e,t)}catch{}}function ke(e){try{localStorage.removeItem(e)}catch{}}function $t(e){try{return localStorage.getItem(e)}catch{return null}}var Wn=new Set(["textarea","input","summary","details","button","audio","video","select","option","a","area","modal"]),Ar=()=>{let e=document.activeElement?.tagName.toLowerCase()??"";return Wn.has(e)};var b=HTMLElement,A=HTMLInputElement,G=HTMLButtonElement,Lr=p("#error",b),L=p("#input",HTMLTextAreaElement),kr=p("#output",HTMLTextAreaElement),Mr=p("#steps",b),v=p("#toggle",G),V=p("#reset",G),D=p("#step",G),Jt=p("#step-text",b),Ur=p("#config_button",G),ut=p("#stats_button",G),zr=p("#current_state",b),Or=p("#previous_output",b),Hr=p("#frequency_input",A),Fr=p("#frequency_output",b),Gr=p("#command",b),te=p("#canvas",HTMLCanvasElement),ee=te.getContext("2d")??(()=>{throw Error("context is null")})(),wt={x:p("#b2dx",b),y:p("#b2dy",b)},_t=p("#b2d_detail",HTMLDetailsElement),Vr=p("#unary_register",b),re=p("#unary_register_detail",HTMLDetailsElement),Pr=p("#binary_register",b),ne=p("#binary_register_detail",HTMLDetailsElement),Yr=p("#add_sub_mul",b),Wr=p("#import_file",A),se=p("#examples",G),Zr=document.querySelectorAll(".js_example"),Me=p("#config_modal_content",b),Tt=p("#step_input",A),w={$hideBits:p("#hide_bits",A),$reverseBits:p("#reverse_bits",A),$showBinaryValueInDecimal:p("#show_binary_value_in_decimal",A),$showBinaryValueInHex:p("#show_binary_value_in_hex",A)},Ue=p("#breakpoint_select",HTMLSelectElement),qr=p("#breakpoint_input_select",HTMLSelectElement),Nt=p("#dark_mode",A),ze=p("#dark_mode_label",b),ie=p("#b2d_hide_pointer",A),Bt=p("#b2d_flip_upside_down",A),oe=p("#stats_modal",b),jr=p("#stats_body",b),Xr=p("#stats_number_of_states",b),Kr=p("#view-state-diagram",G),Qr=p("#add-library-file",G),Jr=p("#library-list",b),Oe=p('#library_modal [data-bs-dismiss="modal"]',b),ae=p("#add-binary-library-file",G);var He="A1",Fe="B0",Ge="B1",tn="ADD",Zn=e=>{switch(e){case 0:return He;case 1:return Fe;case 2:return Ge}},qn=e=>{switch(e){case He:return 0;case Fe:return 1;case Ge:return 2}},k=class e extends h{constructor(t){super(),this.op=t}pretty(){return`${tn} ${Zn(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===tn&&(s===He||s===Fe||s===Ge))return new e(qn(s))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof e}};var en="HALT_OUT",E=class e extends h{constructor(){super()}pretty(){return en}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===en)return new e}doesReturnValue(){return!1}isSameComponent(t){return t instanceof e}};var Ve="0",Pe="1",rn="MUL",jn=e=>{switch(e){case Ve:return 0;case Pe:return 1}},Xn=e=>{switch(e){case 0:return Ve;case 1:return Pe}},ft=class e extends h{constructor(t){super(),this.op=t}pretty(){return`${rn} ${Xn(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===rn&&(s===Ve||s===Pe))return new e(jn(s))}doesReturnValue(){return!0}isSameComponent(t){return t instanceof e}};var nn="NOP",J=class e extends h{constructor(){super()}pretty(){return nn}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==1)return;let[n]=r;if(n===nn)return new e}doesReturnValue(){return!0}isSameComponent(t){return t instanceof e}};var sn="OUTPUT",mt=class e extends h{constructor(t){super(),this.digit=t}pretty(){return`${sn} ${this.digit}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===sn&&s!==void 0)return new e(s)}doesReturnValue(){return!1}isSameComponent(t){return t instanceof e}};var Ye="A1",We="B0",Ze="B1",on="SUB",Kn=e=>{switch(e){case 0:return Ye;case 1:return We;case 2:return Ze}},Qn=e=>{switch(e){case Ye:return 0;case We:return 1;case Ze:return 2}},ht=class e extends h{constructor(t){super(),this.op=t}pretty(){return`${on} ${Kn(this.op)}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(n===on&&(s===Ye||s===We||s===Ze))return new e(Qn(s))}doesReturnValue(){switch(this.op){case 0:return!1;case 1:return!0;case 2:return!0}}isSameComponent(t){return t instanceof e}};var qe="INC",je="DEC",Xe="READ",Ke="SET",Qe="RESET",Jn=e=>{switch(e){case 0:return qe;case 1:return je;case 2:return Xe;case 3:return Ke;case 4:return Qe}},ts=e=>{switch(e){case qe:return 0;case je:return 1;case Xe:return 2;case Ke:return 3;case Qe:return 4}},W=class e extends h{constructor(t,r){super(),this.op=t,this.regNumber=r}pretty(){return`${Jn(this.op)} T${this.regNumber}`}static parse(t){let r=t.trim().split(/\s+/u);if(r.length!==2)return;let[n,s]=r;if(!(n===void 0||s===void 0)&&(n===qe||n===je||n===Xe||n===Ke||n===Qe)&&s.startsWith("T")){let i=s.slice(1);if(/^[0-9]+$/u.test(i))return new e(ts(n),parseInt(i,10))}}doesReturnValue(){switch(this.op){case 0:return!0;case 1:return!0;case 2:return!0;case 3:return!1;case 4:return!1}}isSameComponent(t){return t instanceof e?this.regNumber===t.regNumber:!1}};var le=class{constructor(){this.value=0}action(t){switch(t.op){case 1:{let r=this.value,n=r%2;return this.value=[0,0,0,0,0,0,9,9,0,0,9,9,9,9,9,9][r]??c(),n}case 2:{let r=this.value,n=1-r%2;return this.value=[0,0,0,0,9,9,0,0,9,9,0,0,9,9,9,9][r]??c(),n}case 0:{this.value=[5,4,7,6,1,0,3,2,13,12,15,14,9,8,11,10][this.value]??c();return}default:c()}}getValue(){return this.value}a1(){this.action(new k(0))}b0(){let t=this.action(new k(1));return t===void 0&&c(),t}b1(){let t=this.action(new k(2));return t===void 0&&c(),t}toString(){return this.value.toString(2).padStart(4,"0")}toStringDetail(){let t=this.toString();return`${t.slice(0,3)} bit${t.slice(3)}`}};var pe=class{constructor(){this.value=0}action(t){switch(t.op){case 0:return this.mul0();case 1:return this.mul1();default:throw Error("MUL: action")}}getValue(){return this.value}mul0(){let t=this.value,r=t%2;return this.value=t>>1,r}mul1(){let t=this.value,r=t%2;return t<=21?this.value=(t>>1)+5:this.value=t-22>>1,r}toString(){return this.value.toString(2).padStart(5,"0")}};var de=class{constructor(){}action(){return 0}};var fe=class{#e="";constructor(){}action(t){this.output(t.digit)}getString(){return this.#e}output(t){this.#e+=t}};var me=class{constructor(){this.value=0}action(t){switch(t.op){case 1:return this.b0();case 0:return this.a1();case 2:return this.b1();default:c()}}getValue(){return this.value}a1(){let r=[3,2,-1,-1,7,6,-1,-1,11,10,-1,-1,15,14,-1,-1,19,18,-1,-1,23,22,-1,-1,27,26,-1,-1,31,30,-1,-1][this.value]??c();if(r===-1)throw Error("SUB error: A1");this.value=r}b0(){let t=this.value%2,r=[0,0,0,0,17,17,0,0,0,0,0,0,0,0,17,17,17,17,0,0,17,17,17,17,0,0,17,17,17,17,17,17];return this.value=r[this.value]??c(),t}b1(){let t=1-this.value%2,r=[17,17,0,0,0,0,0,0,0,0,17,17,0,0,0,0,17,17,17,17,17,17,0,0,17,17,17,17,0,0,17,17];return this.value=r[this.value]??c(),t}toString(){return this.value.toString(2).padStart(5,"0")}toStringDetail(){let t=this.toString();return t.slice(0,3)+" stopper"+t.slice(3,4)+" bit"+t.slice(4)}};var he=class{constructor(){this.pointer=0,this.bits=[0]}action(t){switch(t.op){case 0:return this.inc();case 2:return this.read();case 1:return this.dec();case 3:return this.set();case 4:return this.reset();default:c()}}getPointer(){return this.pointer}getBits(){return this.bits}inc(){let t=this.bits;return this.pointer===t.length-1?(t.push(0),this.pointer++,0):(this.pointer++,1)}dec(){return this.pointer===0?0:(this.pointer--,1)}read(){let t=this.pointer,r=this.bits,n=r[t];if(n===0)return r[t]=-1,0;if(n===1)return r[t]=-1,1;if(n===-1)throw Error("Error: reading empty space of T register");c()}set(){let t=this.pointer;if(this.bits[t]===-1)this.bits[t]=1;else throw Error("Error: SET to nonempty bit")}reset(){let t=this.pointer;if(this.bits[t]===-1)this.bits[t]=0;else throw Error("Error: RESET to nonempty bit")}};var Mt=(e,t)=>{throw Error(`Register ${e}${t} is not found.`)},an=Number.parseInt,cn=Number.isNaN,ge=class{constructor({unary:t,binary:r,legacyT:n}){this.uRegMap=new Map(t.map(s=>[s,new Yt])),this.bRegMap=new Map(r.map(s=>[s,new Zt])),this.legacyTRegMap=new Map(n.map(s=>[s,new he])),this.add=new le,this.sub=new me,this.mul=new pe,this.b2d=new Pt,this.output=new fe,this.nop=new de}setByRegistersInit(t){for(let[r,n]of Object.entries(t))this.#e(r,n)}setCache(t){t instanceof x?t.registerCache=this.getBReg(t.regNumber):t instanceof S&&(t.registerCache=this.getUReg(t.regNumber))}#e(t,r){if(t.startsWith("U")){let n=an(t.slice(1),10);cn(n)&&Y(t,r);let s=this.getUReg(n);if(s===void 0)throw Error(`Invalid #REGISTERS: U${n} isn't used in the program`);s.setByRegistersInit(t,r)}else if(t.startsWith("B")){let n=an(t.slice(1),10);cn(n)&&Y(t,r);let s=this.getBReg(n);if(s===void 0)throw Error(`Invalid #REGISTERS: B${n} isn't used in the program`);s.setByRegistersInit(t,r)}else Y(t,r)}execAction(t){if(t instanceof x)return(t.registerCache??this.bRegMap.get(t.regNumber)??Mt("B",t.regNumber)).action(t);if(t instanceof S)return(t.registerCache??this.uRegMap.get(t.regNumber)??Mt("U",t.regNumber)).action(t);if(t instanceof k)return this.add.action(t);if(t instanceof J)return this.nop.action();if(t instanceof ht)return this.sub.action(t);if(t instanceof ft)return this.mul.action(t);if(t instanceof ot)return this.b2d.action(t);if(t instanceof mt)return this.output.action(t);if(t instanceof E)return-1;if(t instanceof W)return(this.legacyTRegMap.get(t.regNumber)??Mt("T",t.regNumber)).action(t);throw Error(`execAction: unknown action ${t.pretty()}`)}execActionN(t,r){if(t instanceof S)return(t.registerCache??this.uRegMap.get(t.regNumber)??Mt("U",t.regNumber)).actionN(t,r);if(t instanceof x)return(t.registerCache??this.bRegMap.get(t.regNumber)??Mt("B",t.regNumber)).actionN(t,r);if(t instanceof E)return-1;throw Error(`execActionN: ${t.pretty()}`)}getUReg(t){return this.uRegMap.get(t)}getBReg(t){return this.bRegMap.get(t)}addSubMulToUIString(){return`
        ADD = ${this.add.toStringDetail()},
        SUB = ${this.sub.toStringDetail()},
        MUL = ${this.mul.toString()}
        `}};var Je=e=>{let t=[x.parse,S.parse,ot.parse,J.parse,k.parse,ft.parse,ht.parse,mt.parse,E.parse,W.parse];for(let r of t){let n=r(e);if(n!==void 0)return n}};var _=e=>e!==void 0?` at line ${e}`:"";function tr(e,t,r,n){let s=e.trim();if(!s.startsWith("{"))return`Invalid line "${r}"${_(t)}. ${n} replacements does not start with "{"`;if(!s.endsWith("}"))return`Invalid line "${r}"${_(t)}. ${n} replacements does not end with "}"`;try{return e.slice(1,-1).slice().split(";").map(i=>{let o=i.trim().split("=").map(a=>a.trim());if(o.length!=2)throw new Error(`Invalid line "${e}"${_(t)}. #DEFINE invalid replacements`);return{needle:o[0]??c(),replacement:o[1]??c()}})}catch(i){return i instanceof Error?i.message:c()}}var Ut="INITIAL",N=class{pretty(){return""}},tt=class e extends N{constructor(t){super(),this.content=t}static get key(){return"#COMPONENTS"}pretty(){return e.key+" "+this.content}},et=class e extends N{constructor(t){super(),this.content=t}static get key(){return"#REGISTERS"}pretty(){return e.key+" "+this.content}};function un(e){return"{ "+e.map(t=>t.needle+" = "+t.replacement).join("; ")+" }"}var rt=class e extends N{constructor(t,r){super(),this.name=t,this.defaultReplacements=r}static get key(){return"#DEFINE"}pretty(){return e.key+" "+this.name+(this.defaultReplacements.length===0?"":" "+un(this.defaultReplacements))}},q=class e extends N{constructor(){super()}static get key(){return"#ENDDEF"}pretty(){return e.key}},Z=class e extends N{constructor(t,r){super(),this.templateName=t,this.replacements=r}static get key(){return"#INSERT"}pretty(){return e.key+" "+this.templateName+(this.replacements.length===0?"":" "+un(this.replacements))}},nt=class extends N{constructor(t){super(),this.filename=t}static get key(){return"#INCLUDE"}pretty(){return Z.key+" "+this.filename}},er=class extends N{constructor(t){super(),this.str=t}getString(){return this.str}pretty(){return this.getString()}},rr=class extends N{constructor(){super()}pretty(){return""}},es=e=>{switch(e){case"Z":return e;case"NZ":return e;case"ZZ":return e;case"*":return e;default:return}},gt=class extends N{constructor({state:t,input:r,nextState:n,actions:s,line:i}){super(),this.state=t,this.input=r,this.nextState=n,this.actions=s,this.line=i,this._string=`${this.state}; ${this.input};${" ".repeat(2-this.input.length)} ${this.nextState}; ${this.actions.map(o=>o.pretty()).join(", ")}`}pretty(){return this._string}},nr=(e,t)=>{let r=e.trim();if(r==="")return new rr;if(r.startsWith("#")){if(r.startsWith(tt.key))return new tt(r.slice(tt.key.length).trim());if(r.startsWith(et.key))return new et(r.slice(et.key.length).trim());if(r.startsWith(rt.key)){let m=r.slice(rt.key.length).trim();if(m.length===0)return`Invalid line "${e}"${_(t)}. #DEFINE needs a name.`;let y,$=[];if(m.includes("{")){y=m.slice(0,m.indexOf("{")).trim();let I=tr(m.slice(m.indexOf("{")),t,e,"#DEFINE");if(typeof I=="string")return I;$=I}else y=m;return new rt(y,$??[])}else{if(r.startsWith(q.key))return new q;if(r.startsWith(Z.key)){let m=r.slice(Z.key.length).trim();if(m.length===0)return`Invalid line "${e}"${_(t)}. #INSERT needs a name.`;let y,$=[];if(m.includes("{")){y=m.slice(0,m.indexOf("{")).trim();let I=tr(m.slice(m.indexOf("{")),t,e,"#INSERT");if(typeof I=="string")return I;$=I}else y=m;return new Z(y,$)}else if(r.startsWith(nt.key)){let m=r.slice(nt.key.length).trim();return m===""?`Invalid line "${e}"${_(t)}. #INCLUDE needs filename.`:new nt(m)}}return new er(e)}let s=(r.split("#")[0]??"").split(/\s*;\s*/u);if(s.length<4)return`Invalid line "${e}"${_(t)}`;if(s.length>4)return s[4]===""?`Extraneous semicolon "${e}"${_(t)}`:`Invalid line "${e}"${_(t)}`;let i=s[0]??c(),o=s[1]??c(),a=s[2]??c(),l=(s[3]??c()).trim().split(/\s*,\s*/u).filter(m=>m!==""),f=[];for(let m of l){let y=Je(m);if(y===void 0)return`Unknown action "${m}" in "${e}"${_(t)}`;f.push(y)}let T=es(o);return T===void 0?`Unknown input "${o}" in "${e}"${_(t)}. Expect "Z", "NZ", "ZZ" or "*"`:new gt({state:i,input:T,nextState:a,actions:f,line:t})},P=e=>_(e.line),B=e=>`"${e.pretty()}"${P(e)}`;var ln=e=>{let t=e.actions;if(t.some(n=>n instanceof E))return;let r=t.filter(n=>n.doesReturnValue());if(r.length!==1)return r.length===0?`Does not produce the return value in ${B(e)}`:`Does not contain exactly one action that produces a return value in "${e.pretty()}": Actions that produce value are ${r.map(n=>`"${n.pretty()}"`).join(", ")}${P(e)}`};var pn=e=>{if(e.nextState===Ut)return`Return to initial state in ${B(e)}`};var dn=e=>{let t=e.actions;if(t.length<=1)return;let r=t.map(s=>s.pretty());r.sort();let n=r.length-1;for(let s=0;s<n;s++){let i=r[s],o=r[s+1];if(i===o)return`Duplicated actions "${i}" in ${B(e)}`}};var fn=e=>{let t=e.actions;if(t.find(n=>n instanceof E)!==void 0)return;let r=t.length;if(!(r<=1))for(let n=0;n<r;n++){let s=t[n]??c();for(let i=n+1;i<r;i++){let o=t[i]??c();if(s.isSameComponent(o))return`Actions "${s.pretty()}" and "${o.pretty()}" use same component in ${B(e)}`}}};var rs=(e,t)=>e.line!==void 0&&t?.line!==void 0?` at line ${e.line} and ${t.line}`:"",mn=e=>{if(e.length===0)return;let t=(s,i)=>`Need Z line followed by NZ line in "${s.pretty()}"${rs(s,i)}`,r=e.length-1;for(let s=0;s<r;s++){let i=e[s]??c(),o=e[s+1]??c(),a=i.input,u=o.input;if(a==="Z"&&u!=="NZ"||u==="NZ"&&a!=="Z"||a==="Z"&&u==="NZ"&&i.state!==o.state)return[t(i,o)]}let n=e[r];if(n?.input==="Z")return[t(n)]};var j=class e{constructor(t,r=new Map){this.templates=r,this.array=t}getArray(){return this.array}getTemplates(){return this.templates}pretty(){return this.array.map(t=>t.pretty()).join(`
`)}static parse(t){let r=t.split(/\r\n|\n|\r/u),n=[],s=[],i=new Map,o=null;for(let[a,u]of r.entries()){if(o!=null){if(u.trimStart().startsWith(q.key)&&nr(u,a+1)instanceof q){o=null;continue}let f=i.get(o);f==null&&c(),f.lines.push(u);continue}let l=nr(u,a+1);if(l instanceof rt){if(o!=null)return`#DEFINE needs #ENDDEF ${l.pretty()}`;if(o=l.name,i.has(o))return`#DEFINE duplicate template name ${l.pretty()}`;i.set(o,{defaultReplacements:l.defaultReplacements,lines:[]})}else{if(l instanceof q)return`#ENDDEF needs #DEFINE ${l.pretty()}`;l instanceof N?s.push(l):typeof l=="string"?n.push(l):c()}}return o!=null&&n.push(`#DEFINE needs #ENDDEF. "${o}"`),n.length>0?n.join(`
`):new e(s,i)}};var hn=e=>{let t=[];{let r=[dn,ln,fn,pn];for(let n of e)for(let s of r){let i=s(n);typeof i=="string"&&t.push(i)}}{let r=[mn];for(let n of r){let s=n(e);s!==void 0&&(t=t.concat(s))}}if(t.length>0)return t.join(`
`)};function ns(e,t,r){let n=e;for(let s of r)n=n.replaceAll(s.needle,s.replacement);for(let s of t.defaultReplacements)n=n.replaceAll(s.needle,s.replacement);return n}function gn(e,t){let r=[],n=new Map(e.getTemplates().entries()),s=e.getArray().slice().reverse();function i(o){let a=o.getArray();for(let u=a.length-1;u>=0;u--)s.push(a[u]??c());for(let[u,l]of o.getTemplates()){if(n.get(u)!=null)throw new Error(`#DEFINE duplicate template name "${u}"`);n.set(u,l)}}for(;s.length>=1;){let o=s.pop();if(o instanceof gt)r.push(o);else if(o instanceof nt){let a=t.find(u=>u.name===o.filename);if(a==null)throw new Error(`#INCLUDE file not found: "${o.filename}". Add a library file.`);i(a.programLines)}else if(o instanceof Z){let a=n.get(o.templateName);if(a==null)throw new Error(`Undefined template: "${o.templateName}"`);let u=a.lines.map(f=>ns(f,a,o.replacements)).join(`
`),l=j.parse(u);if(typeof l=="string")throw new Error(l);i(l)}}return r}var xe=class e{constructor(t,r,n){this.commands=t,this.componentsHeader=r,this.registersHeader=n}static parse(t,{noValidate:r,libraryFiles:n}={}){let s=j.parse(t);if(typeof s=="string")return s;let i=[];for(let a of n??[]){let u=j.parse(a.content);if(typeof u=="string")return u;i.push({name:a.name,programLines:u})}let o=gn(s,i);if(!r){if(o.length===0)return"Program is empty";let a=hn(o);if(typeof a=="string")return a}return new e(o,s.getArray().flatMap(a=>a instanceof tt?[a]:[]),s.getArray().flatMap(a=>a instanceof et?[a]:[]))}},ss=e=>[...new Set(e)].sort((t,r)=>t-r),xn=e=>{let t=e.commands.flatMap(n=>n.actions),r=n=>ss(t.flatMap(s=>s instanceof n?[s.regNumber]:[]));return{unary:r(S),binary:r(x),legacyT:r(W)}};var is=e=>e instanceof x&&e.op===0,os=e=>e instanceof S&&e.op===1,as=e=>{if(e.input==="NZ"&&e.state===e.nextState&&e.actions.every(t=>!(t instanceof E))&&e.actions.every(t=>t instanceof S||is(t))){let t=e.actions.find(os);if(t&&t instanceof S)return{tdecU:t}}},cs=e=>{if(e.input==="NZ"&&e.state===e.nextState&&e.actions.every(t=>!(t instanceof E))&&e.actions.length===1&&e.actions.every(t=>t instanceof x)){let t=e.actions.find(r=>r instanceof x&&r.op===1);if(t&&t instanceof x)return{tdecB:t}}},xt=class{constructor(t,r){this.command=t,this.nextState=r,this.tdecuOptimize=as(t),this.tdecbOptimize=cs(t)}},ir=class{constructor(t,r){this.z=t,this.nz=r}},sr=(e,t)=>{throw Error(`Duplicated command: "${e.pretty()}" and "${t.pretty()}"${P(t)}`)},bn=e=>{let t=new Map,r=[];for(let n of e)t.has(n.state)||(t.set(n.state,t.size),r.push(new ir(void 0,void 0)));for(let n of e){let s=r[t.get(n.state)??c()]??c(),i=t.get(n.nextState);if(i===void 0)throw Error(`Unknown state: "${n.nextState}" at "${n.pretty()}"${P(n)}`);switch(n.input){case"Z":{s.z===void 0?s.z=new xt(n,i):sr(s.z.command,n);break}case"NZ":{s.nz===void 0?s.nz=new xt(n,i):sr(s.nz.command,n);break}case"ZZ":{if(s.nz!==void 0)throw Error(`Invalid input: ZZ with NZ or *: "${n.pretty()}" and "${s.nz.command.pretty()}"${P(n)}`);s.z===void 0?s.z=new xt(n,i):sr(s.z.command,n);break}case"*":{if(s.nz!==void 0)throw Error(`Invalid input: * "${n.pretty()}" and "${s.nz.command.pretty()}"${P(n)}`);if(s.z!==void 0)throw Error(`Invalid input: * "${n.pretty()}" and "${s.z.command.pretty()}"${P(n)}`);{let o=new xt(n,i);s.z=o,s.nz=o}break}default:c()}}return{states:[...t.keys()],stateMap:t,lookup:r}};var C=(e="error")=>{throw Error(e)},zt=class e{constructor(t){this.stepCount=0,this.actionExecutor=new ge(xn(t)),this.prevOutput=0,this.program=t;let{states:r,stateMap:n,lookup:s}=bn(t.commands);this.states=r,this.stateMap=n,this.lookup=s;for(let o of s){let a=(o.z?.command.actions??[]).concat(o.nz?.command.actions??[]);for(let u of a)this.actionExecutor.setCache(u)}this.currentStateIndex=n.get(Ut)??C(`${Ut} state is not present`),this.stateStatsArray=[];for(let o=0;o<s.length*2;o++)this.stateStatsArray.push(0);let i=t.registersHeader;for(let o of i)this.#e(o)}static fromString(t,r){let n=xe.parse(t,{libraryFiles:r??[]});if(typeof n=="string")throw Error(n);return new e(n)}getStateStats(){let t=this.stateStatsArray,r=t.length,n=[];for(let s=0;s<r;s+=2)n.push({z:t[s]??C(),nz:t[s+1]??C()});return n}#e(t){let r=t.content.replace(/'/ug,'"'),n={};try{n=JSON.parse(r)}catch{C(`Invalid #REGISTERS: is not a valid JSON: "${r}"`)}(n===null||typeof n!="object")&&C(`Invalid #REGISTERS: "${r}" is not an object`),this.actionExecutor.setByRegistersInit(n)}getCurrentState(){let t=this.states[this.currentStateIndex];return t===void 0&&C("State name is not found"),t}getStateMap(){return this.stateMap}getPreviousOutput(){return this.prevOutput===0?"Z":"NZ"}getNextCommand(){let t=this.currentStateIndex,r=this.lookup[t];if(r===void 0&&C(`Internal Error: Next command is not found: Current state index: ${t}`),this.prevOutput===0){let s=r.z;if(s!==void 0)return s}else{let s=r.nz;if(s!==void 0)return s}C("Next command is not found: Current state = "+this.getCurrentState()+", output = "+this.getPreviousOutput())}_internalExecActionN(t,r){try{let s=this.actionExecutor;for(let i of t.actions)s.execActionN(i,r)}catch(s){if(s instanceof Error)this.#n(s);else throw s}let n=this.currentStateIndex*2+this.prevOutput;this.stateStatsArray[n]=(this.stateStatsArray[n]??0)+r,this.stepCount+=r}exec(t,r,n,s){let i=n!==-1,o=performance.now();for(let a=0;a<t;a++){let u=this.getNextCommand();if(u.tdecuOptimize){let f=u.tdecuOptimize.tdecU.registerCache?.getValue();if(f!==void 0&&f!==0){f=Math.min(f,t-a),this._internalExecActionN(u.command,f),a+=f-1;continue}}else if(u.tdecbOptimize){let f=u.tdecbOptimize.tdecB.registerCache?.pointer;if(f!==void 0&&f!==0){f=Math.min(f,t-a),this._internalExecActionN(u.command,f),a+=f-1;continue}}try{if(this.execCommandFor(u)===-1)return"Halted"}catch(l){if(l instanceof Error)this.#n(l);else throw l}if(i&&this.currentStateIndex===n&&(s===-1||s===this.prevOutput))return"Stop";if(r&&(a+1)%5e5===0&&performance.now()-o>=50)return}}#n(t){let r=this.getNextCommand().command;return C(t.message+" in "+B(r))}execCommandFor(t){this.stepCount+=1;{let o=this.currentStateIndex,a=this.prevOutput,u=o*2+a;this.stateStatsArray[u]=(this.stateStatsArray[u]??0)+1}let r=-1,n=this.actionExecutor,s=t.command;for(let o of s.actions){let a=n.execAction(o);if(a===-1)return-1;a!==void 0&&(r===-1?r=a:C(`Return value twice: line = ${B(s)}`))}r===-1&&C(`No return value: line = ${B(s)}`);let i=t.nextState;this.currentStateIndex=i,this.prevOutput=r}execCommand(){return this.execCommandFor(this.getNextCommand())}};function us(e,t){let r=document.createElement("input");r.type="file",r.style.display="none",e.addEventListener("click",()=>{r.click()}),r.addEventListener("change",n=>{let s=n.target.files;if(s.length>0){let i=s[0];t(i)}}),document.body.appendChild(r)}var be=class{constructor(){this.files=[]}getFiles(){return this.files.slice()}initialize(){ae.addEventListener("click",async()=>{ae.disabled=!0,this.addFile({name:"binary.apglib",content:await fetch("./frontend/data/binary.apglib").then(t=>t.text()),builtin:!0}),await new Promise(t=>setTimeout(t,500)),Oe.click()}),us(Qr,async t=>{this.addFile({name:t.name,content:await t.text()}),await new Promise(r=>setTimeout(r,500)),Oe.click()})}addFile(t){this.files.push(t);let r=d("td");r.textContent=t.name;let n=d("button",{text:"Delete"});n.className="btn btn-danger btn-sm",n.addEventListener("click",()=>{t.builtin&&(ae.disabled=!1),this.files=this.files.filter(o=>o.name!==t.name),i.remove()});let s=d("td",{children:[n]}),i=d("tr",{children:[r,s]});Jr.append(i)}};var ls=30,ye=class{#e;#n="";#t;#i;#s=new Wt(Vr);#c=new jt(Pr);#a=new Xt(jr,Xr);$libraryUI=new be;#o;#r="Initial";constructor(){this.stepConfig=1,this.#o=new Ht(t=>{this.run(t)},{frequency:ls}),this.$libraryUI.initialize()}setFrequency(t){this.#o.frequency=t,this.#u()}start(){switch(this.#r){case"Initial":{this.reset()&&(this.#r="Running");break}case"Stop":{this.#r="Running";break}default:throw Error("start: unreachable")}this.render()}stop(){this.#r="Stop",this.render()}toggle(){this.#r==="Running"?this.stop():this.start()}#l(){this.#t===void 0?this.#s.clear():this.#s.initialize(this.#t.actionExecutor.uRegMap)}#p(){this.#t===void 0?this.#c.clear():this.#c.initialize(this.#t.actionExecutor.bRegMap)}#d(){this.#l(),this.#p(),this.#h(),Er(Ue,this.#t)}doStep(){if(this.#r==="Running"&&this.stop(),this.stepConfig>=5e6){let t=lr();t.style.position="absolute",D.append(t),Jt.style.color="transparent",D.disabled=!0,V.disabled=!0,v.disabled=!0,setTimeout(()=>{try{this.run(this.stepConfig)}finally{Jt.style.color="",t.remove()}},33)}else this.run(this.stepConfig)}setInputAndReset(t){L.value=t,this.reset()}reset(){this.#n="",this.#t=void 0,this.#o.reset();try{let t=this.$libraryUI.getFiles();this.#t=zt.fromString(L.value,t),this.#d(),this.#r="Stop"}catch(t){return this.#r="ParseError",this.#n=$e(t),this.render(),!1}return this.render(),!0}#u(){let t=this.#o.frequency;this.#i!==t&&(Fr.textContent=R(t),this.#i=t)}#f(){try{let t=this.#t?.getNextCommand();Gr.textContent=t?.command.pretty()??""}catch(t){console.error(t)}}renderB2D(){if(!_t.open)return;let t=this.#t;if(t===void 0){wt.x.textContent="0",wt.y.textContent="0",ee.clearRect(0,0,te.width,te.height),ee.resetTransform();return}let r=t.actionExecutor.b2d;wt.x.textContent=r.x.toString(),wt.y.textContent=r.y.toString();let n=performance.now();gr(ee,r,ie.checked,Bt.checked),this.#r==="Running"&&performance.now()-n>=200&&(_t.open=!1)}renderUnary(){this.#t!==void 0&&re.open&&this.#s.render(this.#t.actionExecutor.uRegMap)}renderBinary(){this.#t!==void 0&&ne.open&&this.#c.render(this.#t.actionExecutor.bRegMap,w.$hideBits.checked,w.$reverseBits.checked,w.$showBinaryValueInDecimal.checked,w.$showBinaryValueInHex.checked)}#m(){let t=this.#t?.actionExecutor.output.getString();Ir(kr,t)}#h(){this.#t===void 0?this.#a.clear():this.#a.initialize(this.#t.getStateStats(),this.#t.states)}renderStats(){if(oe.classList.contains("show")){if(this.#t===void 0){this.#a.clear();return}this.#a.render(this.#t.getStateStats(),this.#t.currentStateIndex)}}#g(){switch(this.#r){case"Initial":{yt(v),D.disabled=!1,V.disabled=!1,ut.disabled=!0;break}case"Stop":{yt(v),D.disabled=!1,V.disabled=!1,ut.disabled=!1;break}case"Running":{Nr(v),D.disabled=!0,V.disabled=!0,ut.disabled=!1;break}case"RuntimeError":case"ParseError":{yt(v),v.disabled=!0,D.disabled=!0,V.disabled=!1,ut.disabled=!0;break}case"Halted":{yt(v),v.disabled=!0,D.disabled=!0,V.disabled=!1,ut.disabled=!1;break}}}render(){let t=this.#r;this.#o.disabled=t!=="Running",(this.#e!==t||t==="Stop")&&(this.#g(),t==="ParseError"?L.classList.add("is-invalid"):L.classList.remove("is-invalid")),Br(Lr,t,this.#n),this.#u();let r=this.#t;zr.textContent=r?.getCurrentState()??"",Or.textContent=r?.getPreviousOutput()??"",Mr.textContent=r?.stepCount.toLocaleString()??"";let n=this.stepConfig;Jt.textContent=n===1?"Step":`${R(n)} Steps`,this.#f(),this.#m(),this.renderUnary(),this.renderBinary(),Yr.textContent=r?.actionExecutor.addSubMulToUIString()??"",this.renderB2D(),this.renderStats(),this.#e=t}run(t){switch(this.#r){case"Initial":if(!this.reset())return}if(t<=0||isNaN(t))return;let r=this.#t;if(r===void 0)return;let n=this.#r==="Running",s=parseInt(Ue.value,10),i=$r(qr);try{let o=r.exec(t,n,s,i);o!==void 0&&(this.#r=o)}catch(o){this.#r="RuntimeError",this.#n=$e(o)}finally{this.render()}}};var ps="./frontend/data/",g=new ye;V.addEventListener("click",()=>{g.reset()});v.addEventListener("click",()=>{g.toggle()});D.addEventListener("click",()=>{g.doStep()});Zr.forEach(e=>{e.addEventListener("click",async()=>{se.style.opacity="0.5";let t=e.dataset.src;try{let r=await fetch(ps+t);if(!r.ok)throw Error("error");g.setInputAndReset(await r.text()),cr()}catch(r){throw r}finally{se.removeAttribute("style")}})});Rr(Hr,g);_t.addEventListener("toggle",()=>{g.renderB2D()});ne.addEventListener("toggle",()=>{g.renderBinary()});re.addEventListener("toggle",()=>{g.renderUnary()});var cr=()=>{L.scrollTop=0};Cr(Wr,e=>{g.setInputAndReset(e),cr()});Tt.addEventListener("input",()=>{let e=Number(Tt.value);isNaN(e)||e<=0||!Number.isInteger(e)?(vr(Tt,"Enter a positive integer"),g.stepConfig=1):(Dr(Tt),g.stepConfig=e),g.render()});var Ot=(e,t)=>{e.addEventListener("change",()=>{g.render(),Et(t,e.checked.toString())})},yn="hide_binary";Ot(w.$hideBits,yn);var Sn="reverse_binary";Ot(w.$reverseBits,Sn);var Se="show_binary_in_decimal";Ot(w.$showBinaryValueInDecimal,Se);var En="show_binary_in_hex";Ot(w.$showBinaryValueInHex,En);ie.addEventListener("change",()=>{g.renderB2D()});var $n="b2d_flip_upside_down";Ot(Bt,$n);oe.addEventListener("shown.bs.modal",()=>{g.renderStats()});Kr.addEventListener("click",()=>{L.value.length>=10**6||(Et("state-diagram-input",L.value),window.open("./tools/diagram/index.html",void 0,"noreferrer=yes,noopener=yes"))});var or="apge_dark",Ee="on",ar="dark_mode";Nt.addEventListener("change",()=>{Nt.checked?(Et(ar,Ee),document.body.setAttribute(or,Ee)):(ke(ar),document.body.removeAttribute(or)),ze.textContent=Nt.checked?"On":"Off";let e="dark-mode-anim";document.body.classList.add(e),Me.classList.add(e),setTimeout(()=>{document.body.classList.remove(e),Me.classList.remove(e)},500)});document.addEventListener("keydown",e=>{if(!(Ar()||e.isComposing||e.metaKey||e.shiftKey||e.ctrlKey))switch(e.code){case"Enter":{g.toggle();break}case"Space":{D.disabled||(e.preventDefault(),g.doStep());break}}});L.addEventListener("drop",async e=>{e.preventDefault();let t=e.dataTransfer?.files.item(0);t!=null&&(g.setInputAndReset(await t.text()),cr())});se.disabled=!1;Ur.disabled=!1;g.render();Qt(()=>{let e="initial_code",t=$t(e);t!==null&&(ke(e),g.setInputAndReset(t))});Qt(()=>{$t(Se)===null&&Et(Se,"true");let e=[{key:$n,checkbox:Bt},{key:Sn,checkbox:w.$reverseBits},{key:yn,checkbox:w.$hideBits},{key:Se,checkbox:w.$showBinaryValueInDecimal},{key:En,checkbox:w.$showBinaryValueInHex}];for(let{key:t,checkbox:r}of e)$t(t)==="true"&&(r.checked=!0);$t(ar)===Ee&&(document.body.setAttribute(or,Ee),Nt.checked=!0,ze.textContent="On"),g.render()});"serviceWorker"in navigator&&Qt(async()=>{(await navigator.serviceWorker.getRegistrations()).map(t=>t.unregister())});
